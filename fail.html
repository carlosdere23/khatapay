<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment Failed - Bologus pvt store.</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f3f4f6;
      min-height: 100vh;
    }
    .header {
      background-color: #EF4444;
      padding: 1rem;
      color: white;
    }
    .fail-icon {
      width: 80px;
      height: 80px;
      background-color: #EF4444;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }
    .fail-icon svg {
      width: 50px;
      height: 50px;
      color: white;
    }
    .divider {
      height: 1px;
      background-color: #e5e7eb;
      margin: 1.5rem 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container mx-auto px-4">
      <h1 class="text-xl font-medium">Bologus pvt store.</h1>
    </div>
  </div>

  <div class="container mx-auto px-4 py-10 max-w-3xl">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <div class="p-6 md:p-8">
        <!-- Fail Icon -->
        <div class="fail-icon mb-6">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <path d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </div>

        <h2 class="text-2xl font-medium text-center text-red-600 mb-2">Payment Failed</h2>
        <p class="text-center text-gray-500 mb-8" id="failureReason">Transaction declined by bank</p>

        <div class="divider"></div>

        <!-- Transaction Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Left Column -->
          <div>
            <h3 class="text-gray-500 mb-1">Amount to pay</h3>
            <p class="text-xl font-medium mb-4">₹ <span id="amount">0.00</span></p>

            <h3 class="text-gray-700 font-medium">Payment for</h3>
            <p class="text-gray-500 mb-6" id="description">The learning products...</p>

            <!-- Products Table -->
            <div class="border border-gray-200 rounded-md mb-4">
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-2 text-left text-gray-500">Item name</th>
                    <th class="px-4 py-2 text-right text-gray-500">QTY</th>
                    <th class="px-4 py-2 text-right text-gray-500">PRICE</th>
                  </tr>
                </thead>
                <tbody id="productsList">
                  <!-- Will be populated by JavaScript -->
                </tbody>
                <tfoot>
                  <tr class="border-t border-gray-200">
                    <td colspan="2" class="px-4 py-2 text-right font-medium">Total:</td>
                    <td class="px-4 py-2 text-right font-medium">₹ <span id="totalAmount">0.00</span></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- Right Column -->
          <div class="bg-gray-50 p-4 rounded-md">
            <p class="text-sm text-gray-500 mb-4">Transaction Reference</p>
            <p class="text-sm font-medium mb-4" id="transactionId">mJm3t3gU7BofTeA</p>
            
            <p class="text-sm text-gray-500 mb-1">Transaction Date</p>
            <p class="text-sm font-medium mb-6" id="transactionDate">Mar 2, 2023, at 4:51 pm</p>
            
            <a href="/" class="block text-center bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
              Try Again
            </a>
            <p class="text-center text-xs text-gray-400 mt-2">You will be redirected in <span id="countdown">10</span> seconds</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const invoiceId = new URLSearchParams(window.location.search).get('invoiceId');
      const reasonFromUrl = new URLSearchParams(window.location.search).get('reason');
      
      if (!invoiceId) {
        window.location.href = '/';
        return;
      }

      try {
        // Fetch transaction details
        const response = await fetch(`/api/getTransactionForFail?invoiceId=${invoiceId}&reason=${reasonFromUrl || ''}`);
        const data = await response.json();
        
        if (data.status !== 'failed') {
          throw new Error('Failed to load transaction data');
        }

        // Populate page with transaction details
        document.getElementById('amount').textContent = parseFloat(data.data.amount).toFixed(2);
        document.getElementById('totalAmount').textContent = parseFloat(data.data.amount).toFixed(2);
        document.getElementById('transactionId').textContent = data.data.invoiceId;
        document.getElementById('transactionDate').textContent = data.data.timestamp;
        document.getElementById('failureReason').textContent = data.data.reason || 'Transaction failed';
        
        // Basic description - truncated
        document.getElementById('description').textContent = 'Payment for Digital Course Bundle – Premium access...';
        
        // Populate products (sample product data)
        const productsList = document.getElementById('productsList');
        
        // Create a line item - use the whole amount as a single item
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-2 text-gray-800">Digital Course Bundle</td>
          <td class="px-4 py-2 text-right text-gray-800">1</td>
          <td class="px-4 py-2 text-right text-gray-800">₹ ${parseFloat(data.data.amount).toFixed(2)}</td>
        `;
        productsList.appendChild(tr);
        
        // Set up redirect countdown
        let seconds = 10;
        const countdownElement = document.getElementById('countdown');
        const countdownInterval = setInterval(() => {
          seconds--;
          countdownElement.textContent = seconds;
          
          if (seconds <= 0) {
            clearInterval(countdownInterval);
            window.location.href = '/';
          }
        }, 1000);
        
      } catch (error) {
        console.error('Error loading transaction data:', error);
      }
    });
  </script>
</body>
</html>
